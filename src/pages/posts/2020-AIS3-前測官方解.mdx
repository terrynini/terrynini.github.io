---
title: "2020::AIS3::å‰æ¸¬å®˜æ–¹è§£"
description: ""
publishDate: "2020-06-29"
category: "CTF"
layout: "../../layouts/ArticleLayout.astro"
---


ä»Šå¹´çš„ AIS3 å‰æ¸¬åˆè¼ªåˆ°æˆ‘å‡ºé€†å‘æ¯’å®³å¤§å®¶ï¼Œé€™æ¬¡æ¯å€‹é¡Œç¨®å…¶å¯¦éƒ½æœ‰ä¸€é¡Œè€ƒå¤é¡Œï¼Œæ•´é«”é›£åº¦ä¹Ÿæœ‰ä¸‹ä¿®ï¼Œæ„æ€å°±æ˜¯è§£æ³•å¾ˆå¤šç¨®ï¼Œæ²’æœ‰å…¨éƒ¨æ“‹èµ·ä¾†ï¼Œæ˜¯å€‹ä¸»è¾¦é‚£é‚Šå¸Œæœ›å¤§å®¶éƒ½èƒ½å­¸åˆ°æ±è¥¿çš„æ¦‚å¿µï¼Œæ‰€ä»¥é€™ç¯‡ writeup çš„å­—æ•¸å¯èƒ½ä¹Ÿæœƒå¾ˆå¤šï¼Œå¸Œæœ›æ²’è§£é–‹çš„ã€æˆ–æ˜¯å®Œå…¨ä¸çŸ¥é“è¦å¹¹å˜›çš„äººéƒ½èƒ½çœ‹æ‡‚ã€‚

ç„¶å¾Œ source code åœ¨é€™è£¡ [github](https://github.com/terrynini/MyCTFChallenges)

ç¸½ä¹‹é€™è£¡æ˜¯æˆ‘é è¨­çš„è§£æ³•, gogoï¼š

---

# ğŸ TsaiBro (è€ƒå¤é¡Œ)

## é¡Œç›®æ•˜è¿°

> å¾ˆå¥½....ä½ å¾ˆè…¦æ®˜å—....æ•¢é€™æ¨£è¬›åˆ€åŠç¥åŸŸ.......æˆ‘æ­»ä¹Ÿä¸æœƒæ”¾éä½  æˆ‘..è¦..æ®ºæ­»...ä½ ..
> <Image src="./kirito.gif" alt="" />

## é¡Œè§£
é€™é¡Œä¹‹å‰åœ¨ BambooFox é‚€è¬›çš„ç¤¾èª²ä¸Šä¹Ÿæœ‰æåˆ°éï¼Œæ˜¯å€‹å¯ä»¥ä¸ç”¨é€†å‘ä¹Ÿèƒ½å¤ è§£é–‹çš„é¡Œç›®ï¼Œè·Ÿå»å¹´å‰æ¸¬æ˜¯åŒä¸€é¡Œï¼Œé€£åå­—ä¹Ÿæ²’æ› èª’å˜¿([å‚³é€é–€](http://blog.terrynini.tw/tw/2019-AIS3-%E5%89%8D%E6%B8%AC%E5%AE%98%E6%96%B9%E8%A7%A3/#TsaiBro))ï¼Œå·®åˆ¥åªæœ‰ä½¿ç”¨çš„ table ä¸åŒï¼Œé¡Œç›®å¯¦ä½œäº†è‡ªå·±çš„ [Tap code](https://en.wikipedia.org/wiki/Tap_code)ï¼Œé€é 8*8 çš„ table ä¾† encode è¼¸å…¥ï¼š

|    | $1$ | $2$ | $3$ | $4$ | $5$ | $6$ | $7$ | $8$ |
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|  $1$ | 5 | 6 | 7 | 8 | 9 | \{ | } | _ |
|  $2$ | W | X | Y | 0 | y | z | A | B |
|  $3$ | a | b | c | d | m | n | o | p |
|  $4$ | S | T | U | V | G | H | I | J |
|  $5$ | K | L | M | N | u | v | w | x |
|  $6$ | e | f | g | h | q | r | s | t |
|  $7$ | i | j | k | l | O | P | Q | R |
|  $8$ | C | D | E | F | 1 | 2 | 3 | 4 |

èˆ‰ä¾‹ï¼Œ`ï¼·` é€™å€‹å­—æœƒè¢«è½‰æ›æˆ `. ..`ï¼Œä»¥æ­¤é¡æ¨ã€‚
é€™å€‹ table å¯ä»¥é€éé»‘ç®±æ¸¬è©¦æ¨ç†ã€`strings`ã€æˆ–æ˜¯é€†å‘æ‰¾åˆ°ï¼Œé€™è£¡ç”¨ radare2 çœ‹ä¸€ä¸‹å¯ä»¥æ‰¾åˆ° table åœ¨ `0x201020`ï¼š

<Image src="./r2_tsai.png" alt="" />

å¯«å€‹ script æŠŠ `TsaiBroSaid` è§£å›ä¾†å°±å¥½äº†ã€‚

```python solve.py
#!/usr/bin/env python3
table = ['5','6','7','8','9','{','}','_',
'W','X','Y','0','y','z','A','B',
'a','b','c','d','m','n','o','p',
'S','T','U','V','G','H','I','J',
'K','L','M','N','u','v','w','x',
'e','f','g','h','q','r','s','t',
'i','j','k','l','O','P','Q','R',
'C','D','E','F','1','2','3','4']

f = open("./TsaiBroSaid","r").read().split('\n')[1]
f = f.split("ç™¼è²¡")[1:]
for i in range(0,len(f),2):
    print(table[(len(f[i])-1)*8+len(f[i+1])-1],end='')
```

> Flag: `AIS3{y3s_y0u_h4ve_s4w_7h1s_ch4ll3ng3_bef0r3_bu7_its_m0r3_looooooooooooooooooong_7h1s_t1m3}`

åæ§½ä¸€ä¸‹ more long æ˜¯ä»€éº¼çˆ›è‹±æ–‡

---

# ğŸ¹ Fallen Beat

## é¡Œç›®æ•˜è¿°

> CTF player,
> æˆ‘è¦æŒ‘æˆ°ä½ , I'm gonna challenge you!!
> [ZR](https://www.youtube.com/channel/UC5wFI66lU6oqZf-lXiX1lwQ)
> é€™æ˜¯æˆ‘çš„å®¤å‹å…¼ lab åŒå­¸,
> ä»–å·²ç¶“è€ƒéé‡‘æ¡†æš´é¾å¤©ï¼Œä»–æ˜¯å€‹æ—‹éˆ•äºº,
> ä¸åƒä½ æ˜¯å€‹æ•²éµç›¤çš„,
> æ‰€ä»¥æˆ‘è¦æ¸¬æ¸¬ä½ çš„ç¨‹åº¦åˆ°å“ªè£¡,
> å°±ç”¨ ZR çš„å¤§ä¸€ project ä¾†æ±ºå‹è² å§ï¼ï¼
> å¾—åˆ° Full Combo ä¾†è®“æˆ‘åˆ®ç›®ç›¸çœ‹ï¼ï¼

ä¾†è‡ªå®¤å‹å¤§ä¸€çš„ final projectï¼ŒéŸ³æ¨‚éŸ³é‡æ²’æœ‰ normalize å°è‡´æˆ‘å·²ç¶“è€³è¾ï¼Œé¡Œç›®èªªåªè¦ full combo å°±æœƒçµ¦ä½  flagï¼Œé¿å…æœ‰äººå¦„æƒ³ç”¨ç©çš„ï¼Œæ‰€ä»¥è·Ÿæ™®é€šéŸ³éŠè¦å‰‡ä¸åŒï¼Œèª¿æ•´æˆåªæœ‰ perfect æ‰æœƒ comboï¼Œå¦‚æœä½ é‚„ç©å‡ºä¾†äº†ï¼Œéº»ç…©ä¸‹é¢ç•™è¨€ï¼Œæˆ‘è¦è·ªä½ ã€‚

## é¡Œè§£

java æ˜¯ç›´è­¯å¼èªè¨€ï¼Œ compile åªæ˜¯ compile æˆ Java bytecodeï¼Œå¹¾ä¹æ‰€æœ‰çš„æ±è¥¿éƒ½é‚„ç•™è‘—ï¼ŒåŒ…æ‹¬è®Šæ•¸åç¨±ï¼Œdecompile å¾Œå¯ä»¥æ‹¿åˆ°å¹¾ä¹è·ŸåŸå§‹ç¢¼ä¸€æ¨£çš„ java codeï¼Œç›´æ¥ç”¨[ç·šä¸Šå·¥å…·](http://www.javadecompilers.com/)ä¾† decompileï¼Œé€™é¡Œé›£çš„åœ°æ–¹å¤§æ¦‚åªæœ‰ code æ»¿å¤šçš„ï¼Œå¯ä»¥ç›´æ¥æ‰¾ä¸€ä¸‹è®Šæ•¸åç¨±æœ‰æ²’æœ‰ flagï¼š

<Image src="./decompile.png" alt="" />

åœ¨ `Visual/PanelEnding.java` 79 è¡Œé™„è¿‘å¯ä»¥æ‰¾åˆ°ä¸€å€‹è®Šæ•¸å«åš flag ï¼Œå…§å®¹çœ‹èµ·ä¾†åƒæ˜¯è¢«åŠ å¯†éã€‚

```java Visual/PanelEnding.java=79
        this.lWest = new JLabel();
        this.lEast = new JLabel();
        this.flag = new byte[] { 89, 74, 75, 43, 126, 69, 120, 109, 68, 109, 109, 97, 73, 110, 45, 113, 102, 64, 121, 47, 111, 119, 111, 71, 114, 125, 68, 105, 127, 124, 94, 103, 46, 107, 97, 104 };        this.btnFont = new Font("Dialog", 1, 35);
        this.btnBack = new JButton("Back");
        this.setLayout(new BorderLayout());
        this.setBackground(this.c.brown);
```

ç¹¼çºŒå¾€ä¸‹çœ‹ï¼Œåœ¨ `setValue` ä¸­çœ‹å¾—å‡ºä¾†ç•¶ `t == mc` çš„æ™‚å€™ï¼Œ`cache` æœƒæ‹¿ä¾†è·Ÿ `flag` decrypt ç„¶å¾Œå°å‡ºä¾†ï¼š

```java Visual/PanelEnding.java=173
        if (t == mc) {
            for (int i = 0; i < cache.size(); ++i) {
                final byte[] flag = this.flag;
                final int n = i % this.flag.length;
                flag[n] ^= (byte)(Object)cache.get(i);
            }
            final String fff = new String(this.flag);
            this.text[0].setText(String.format("Flag: %s", fff));
        }
```

ç„¶å¾Œè¿½ä¸€ä¸‹ `t`ã€`mc`ã€`cache` åˆ†åˆ¥æ˜¯ä»€éº¼ï¼Œåœ¨ `Control/GameControl.java` ä¸­å¯ä»¥æ‰¾åˆ° `t` å°±æ˜¯é€™å€‹è­œé¢ç¸½å…±æœ‰å¤šå°‘çš„éŸ³ç¬¦ï¼Œ `mc` å°±æ˜¯éŠæˆ²çµæŸæ™‚çš„ combo æ•¸ï¼š

```java Control/GameControl.java=291
this.pe.setValue(this.total, this.critical, this.early, this.late, this.miss, this.comboMax, this.info, this.cache);
```

ç¹¼çºŒå¾€ä¸‹è¿½å¯ä»¥æ‰¾åˆ° cache å…¶å¯¦å°±æ˜¯è®€é€²ä¾†çš„è­œé¢æª”æ¡ˆ

```java Control/GameControl.java=143
            while (br.ready()) {
                final String s = br.readLine();
                if (s.charAt(0) != '*') {
                    final int a = Integer.parseInt(s);
                    this.cache.add(a);
                    for (int k = 0; k < 5; ++k) {
                        if ((a >> k & 0x1) == 0x1) {
                            if (k != 4) {
                                (this.note = new JLabel(this.bt)).setBounds(bounds[k], this.y, 100, 40);
                            }
                            else {
                                (this.note = new JLabel(this.fx)).setBounds(bounds[k], this.y, 350, 40);
                            }
                            this.pFumen.add(this.note);
                            this.check.get(k).add(this.y);
                            ++this.total;
                        }
                    }
                    this.y += this.distance;
                }
            }
```

çœ‹åˆ°é€™è£¡åŸºæœ¬ä¸Šå¯ä»¥æƒ³åˆ°å¹¾å€‹è§£æ³•ï¼š

- æ”¹ `if(t == mc)` çš„ bytecode è®“ä»–ç›´æ¥é€šé
- æ‰¾åˆ° `cache`ï¼Œæ¨¡ä»¿ code è‡ªå·± decrypt
- æ”¹ source code ç„¶å¾Œé‡æ–°ç·¨è­¯
- éŠæˆ²ä¿®æ”¹å™¨
- ...

å› ç‚ºæ²’åšä»€éº¼å¥‡æ€ªçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸Šé¢çš„è§£æ³•æ‡‰è©²éƒ½æ˜¯åšå¾—åˆ°çš„ï¼Œä¸éé‚„æ˜¯æœ€æ¨è–¦ç¬¬äºŒå€‹åšæ³•ï¼Œå› ç‚ºæˆ‘ Mac ä¹Ÿæœƒè·‘ç‰ˆï¼Œæ‰€ä»¥é‚„æ˜¯å¯«è…³æœ¬è§£å¯¦åœ¨ï¼Œç•¶ç„¶ä½ è¦ç›´æ¥æŠ½ code å‡ºä¾†å¯«ä¸€å€‹ java ä¹Ÿè¡Œï¼š

```python solve.py
#!/usr/bin/env python3
flag = [89, 74, 75, 43, 126, 69, 120, 109, 68, 109, 109, 97, 73, 110, 45, 113, 102, 64, 121, 47, 111, 119, 111, 71, 114, 125, 68, 105, 127, 124, 94, 103, 46, 107, 97, 104]

with open('AIS3_2020_pre/Fallen_Beat/songs/gekkou/hell.txt') as f:
    lines = filter(lambda l: '*' not in l, f.readlines()[1:])

for idx,line in enumerate(lines):
        flag[idx%len(flag)] ^= int(line)

print(bytes(flag))
```

> Flag: `AIS3{Wow_how_m4ny_h4nds_do_you_h4ve}`

---

# ğŸ§  Stand up!Brain

## é¡Œç›®æ•˜è¿°

> åˆåˆ°äº† Brain tell å’ª ã„œ joke çš„æ™‚é–“äº†
> é€™æ¬¡è¼ªåˆ°ä½ èªªå€‹ç¬‘è©±ä¾†è½è½äº†
> <Image src="./joke.webp" alt="" />

## é¡Œè§£

é¡Œç›®çµ¦çš„æ˜¯ä¸€å€‹ç”¨ ï¼£ å¯«çš„ [Brainfuck](https://zh.wikipedia.org/wiki/Brainfuck) interpreterï¼Œè€æ¢—ï¼Œä½†ä¸çŸ¥é“ä¹Ÿæ²’é—œä¿‚ï¼Œé‚„æ˜¯å¯ä»¥é€éé€†å‘çœ‹æ‡‚ã€‚

é€™è£¡ç”¨ radare2 disassembleï¼Œ`0x7e2` é€™è£¡å¯ä»¥çœ‹åˆ°è¼¸å…¥æ˜¯ 6 å€‹å­—ï¼Œæ¨æ¸¬è¼¸å…¥æ­£ç¢ºçš„ 6 å€‹å­—å°±æœƒæ‹¿åˆ° flagï¼š

```x86asm scanf
lea rax, [var_eh]
mov rsi, rax
; const char *format
; "%6s"
lea rdi, [0x00000a84]
mov eax, 0
; int scanf(const char *format)
call sym.imp.__isoc99_scanf;[oc]
mov dword [var_24h], 0
jmp 0x853
```

å¯ä»¥å˜—è©¦æš´æœæ­£ç¢ºçš„ 6 å€‹å­—æ˜¯ä»€éº¼ï¼Œä½†æ»¿ä¹…çš„ï¼Œç¹¼çºŒå¾€ä¸‹çœ‹ï¼Œ`0x853` è·Ÿ `0x81c` é€™è£¡æ˜¯ä¸€å€‹ for è¿´åœˆï¼Œæ¯å€‹è¿´åœˆåšçš„äº‹æƒ…æ˜¯æŠŠ input æ‹¿å‡ºä¾†æ”¾åˆ° `0x00201380` çš„ array ä¸Šä¸¦ä¸”å†è£œä¸Šä¸€å€‹å…ƒç´  `1`ï¼Œæ‰€ä»¥ array `0x00201380` æœ€å¾Œæœƒè®Šæˆ `[input[0], 1, input[1], 1, input[2], 1, input[3], 1, input[4], 1, input[5], 1]`ï¼š

```x86asm for_loop
[0x81c]
CODE XREF from main @ 0x857
mov eax, dword [var_24h]
lea edx, [rax + rax]
mov eax, dword [var_24h]
cdqe
movzx ecx, byte [rbp + rax - 0xe] ; get char at input[ecx]
movsxd rdx, edx
lea rax, [0x00201380]
mov byte [rdx + rax], cl
mov eax, dword [var_24h]
add eax, eax
add eax, 1
movsxd rdx, eax
lea rax, [0x00201380]
mov byte [rdx + rax], 1
add dword [var_24h], 1
```

å†å¾€ä¸‹çœ‹ï¼Œæœƒçœ‹åˆ°å¼•ç”¨ä¸€ä¸² dataï¼Œé€™ä¸€ä¸²å°±æ˜¯ Brainfuck ç¨‹å¼ç¢¼ï¼š

```brainfuck
-------------------------------------------------------------------[>[-]<[-]]>[>--------------------------------------------------------[>[-]<[-]]>[>-------------------------------------------------------[>[-]<[-]]>[>------------------------------------------------------[>[-]<[-]]>[>---------------------------------------------------[>[-]<[-]]>[>---------------------------------[>[-]<[-]]>[>>----[---->+<]>++.++++++++.++++++++++.>-[----->+<]>.+[--->++<]>+++.>-[--->+<]>-.[---->+++++<]>-.[-->+<]>---.[--->++<]>---.++[->+++<]>.+[-->+<]>+.[--->++<]>---.++[->+++<]>.+++.[--->+<]>----.[-->+<]>-----.[->++<]>+.-[---->+++<]>.--------.>-[--->+<]>.-[----->+<]>-.++++++++.--[----->+++<]>.+++.[--->+<]>-.-[-->+<]>---.++[--->+++++<]>.++++++++++++++.+++[->+++++<]>.[----->+<]>++.>-[----->+<]>.---[->++<]>-.++++++.[--->+<]>+++.+++.[-]]]]]]]

```

å¦‚æœä¸çŸ¥é“ Brainfuck é‚„æ˜¯èƒ½é€éé€†å‘çŸ¥é“é€™å€‹èªè¨€çš„å¤§æ¦‚ï¼Œç¨‹å¼åœ¨ `0x986` çš„åœ°æ–¹é€²å…¥ä¸€å€‹å¾ˆå¤§çš„ for loopï¼Œ`0x869` é€™è£é–‹å§‹æ˜¯ switch çš„ç¯„åœæª¢æŸ¥ï¼Œç„¶å¾Œå¾€ä¸‹ä¸€é» `0x87f` é€™è£¡æ˜¯ switch æ±ºå®šå»å“ªå€‹ caseï¼Œé€™è£¡çš„ radare2 ä¸‹çš„è¨»è§£æ˜¯éŒ¯çš„ï¼Œå› ç‚ºæœ€å°çš„ case `+(0x2b)` åˆ°æœ€å¤§çš„ case `](0x5d)` é–‰å€é–“é•·åº¦æ˜¯ 51ï¼Œä½†å…¶å¯¦åªæœ‰ 7 å€‹ caseï¼š

```x86asm switch
0x87f [oi]
mov eax, eax
lea rdx, [rax*4]
lea rax, [0x00000a9c]
mov eax, dword [rdx + rax]
movsxd rdx, eax
lea rax, [0x00000a9c]
add rax, rdx
; switch table (51 cases) at 0xa9c
;-- switch
jmp rax
```

é€™å¹¾å€‹ case æ˜¯ `+`ã€`-`ã€`<`ã€`>`ã€`[`ã€`]`ã€`.`ï¼Œçœ‹ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“æ¯å€‹ç¬¦è™Ÿçš„æ„ç¾©äº†ï¼Œæ‰“ä¸‹å»å¤ªå¤šï¼Œç•¥ä¸€æ³¢[wiki](https://zh.wikipedia.org/wiki/Brainfuck)ã€‚
æ‰€ä»¥ç¾åœ¨å¯ä»¥å›é ­çœ‹é‚£ä¸€ä¸² Brainfuck åœ¨å¹¹å˜›äº†ï¼ŒåŸºæœ¬ä¸Š `-------------------------------------------------------------------[>[-]<[-]]>[..ç•¥..]` å…¶å¯¦å°±æ˜¯ `if` ï¼Œæ‰€ä»¥å…¨éƒ¨çš„ code å°±æ˜¯å·¢ç‹€çš„ `if`ï¼Œæ‹¿å€‹ç°¡ç•¥çš„ç‹€æ³èªªæ˜ï¼Œä¸‹é¢é€™æ®µ code çš„é‚è¼¯æ˜¯ `if(var0==1){..ç•¥..}`ï¼š

```brainfuck
# å‡è¨­è¨˜æ†¶é«”é•·é€™æ¨£ memory[4,1]
--[>[-]<[-]]>[..ç•¥..]
```

ä¸€é–‹å§‹ `--` æœƒæŠŠè¨˜æ†¶é«”ä¸Šçš„ `memory[0]` æ‰£ 2 è®Šæˆ 2ï¼ŒåŸ·è¡Œåˆ°`[`æ™‚å¦‚æœç•¶å‰æŒ‡æ¨™æŒ‡åˆ°çš„è¨˜æ†¶é«”ä½ç½®ä¸æ˜¯`0`å°±æœƒé€²å…¥`[>[-]<[-]]`ï¼Œ`[>[-]<[-]]`åšçš„äº‹æƒ…æ˜¯æŠŠä¸‹ä¸€å€‹ä½ç½®ï¼ˆ`memory[1]`ï¼‰æ‰£æˆ 0 ç„¶å¾Œå†æŠŠæŒ‡æ¨™ç§»å›ä¾†`memory[0]`ï¼Œæ¸…ç©º `memory[0]`ï¼Œæ‰€ä»¥ç•¶åŸ·è¡Œåˆ° `>[...ç•¥...]` æ™‚ï¼Œç¬¬ä¸€å€‹`>`ç§»å‹•æŒ‡æ¨™åˆ°`memory[1]`ï¼Œæ˜¯ 0å°±ä¸æœƒå»åŸ·è¡Œ `[...ç•¥...]`ï¼Œé‚£å¦‚æœé‡æ–°ä¾†éï¼Œè¨˜æ†¶é«”ä¸Šçš„ 4 ä¸€é–‹å§‹æ˜¯ 2 çš„è©±ï¼š

```brainfuck
# å‡è¨­è¨˜æ†¶é«”é•·é€™æ¨£ memory[2,1]
--[>[-]<[-]]>[..ç•¥..]
```

ä¸€é–‹å§‹ `--` æœƒæŠŠè¨˜æ†¶é«”ä¸Šçš„ `memory[0]` æ‰£ 2 è®Šæˆ 0ï¼ŒåŸ·è¡Œåˆ°`[`æ™‚å› ç‚ºç¾åœ¨æŒ‡å‘çš„è¨˜æ†¶é«”æ•¸å€¼æ˜¯ 0 æ‰€ä»¥ä¸æœƒé€²å…¥`[>[-]<[-]]`ï¼Œè·³åˆ°å¾Œé¢åŸ·è¡Œ`>[...ç•¥...]`ï¼Œç¬¬ä¸€å€‹`>`ç§»å‹•æŒ‡æ¨™åˆ°`memory[1]`ï¼Œæ˜¯ 1ï¼Œå°±æœƒåŸ·è¡Œ`[...ç•¥...]`ã€‚

åˆ°é€™è£¡å°±å¾ˆæ¸…æ¥šäº†ï¼Œè¼¸å…¥çš„ ascii code è¦ç­‰æ–¼å‰é¢æœ‰å¹¾å€‹`-`ï¼Œé€™æ¨£æ‰æœƒé€šéåˆ¤å®šï¼Œå¯ä»¥çŸ¥é“æ­£ç¢ºçš„è¼¸å…¥æ˜¯`[67, 56, 55, 54, 51, 33]`å°±æ˜¯`C8763!`ï¼ŒæŠŠé‚è¼¯æ›æˆ C æœƒåƒæ˜¯é€™æ¨£ï¼š

```c pseudo_code=
if(input[0] == 'C'){
    if(input[1] == '8'){
        if(input[2] == '7'){
            if(input[3] == '6'){
                if(input[4] = '3'){
                    if(input[5] = '!'){
                        print flag
                    }
                }
            }
        }
    }
}
```

ç•¶ç„¶ä¹Ÿå¯ä»¥ç›´æ¥è·³éæ‰€æœ‰çš„`if`ï¼ŒåªåŸ·è¡Œæœ€å¾Œå° flag çš„ code å°±å¥½äº†ï¼Œå¯ä»¥ç”¨[ç·šä¸Šå·¥å…·](https://www.tutorialspoint.com/execute_brainfk_online.php)ã€‚

```brainfuck print_flag
>>----[---->+<]>++.++++++++.++++++++++.>-[----->+<]>.+[--->++<]>+++.>-[--->+<]>-.[---->+++++<]>-.[-->+<]>---.[--->++<]>---.++[->+++<]>.+[-->+<]>+.[--->++<]>---.++[->+++<]>.+++.[--->+<]>----.[-->+<]>-----.[->++<]>+.-[---->+++<]>.--------.>-[--->+<]>.-[----->+<]>-.++++++++.--[----->+++<]>.+++.[--->+<]>-.-[-->+<]>---.++[--->+++++<]>.++++++++++++++.+++[->+++++<]>.[----->+<]>++.>-[----->+<]>.---[->++<]>-.++++++.[--->+<]>+++.+++.
```

> Flag: `AIS3{Th1s_1s_br4iNFUCK_bu7_m0r3_ez}`

---

# ğŸ¹ Long Island Iced Tea

## é¡Œç›®æ•˜è¿°

> é•·Â·å³¶Â·å†°Â·èŒ¶
> æˆ‘Â·çš„Â·æœ€Â·æ„›
> é•·Â·å³¶Â·å†°Â·èŒ¶
> è¶…Â·çˆ½Â·å£Â·æ„Ÿ
> å’šå’šå’šã„ã„§ã„¤
> å’šå’šå’šã„ã„§ã„¤
> å’šå’šå’šã„ã„§ã„¤
> æˆ‘çœŸçš„å¥½ã„ã„§ã„¤

<iframe src="http://player.bilibili.com/player.html?aid=703074&bvid=BV1Bs411f7DA&cid=1031101&page=1"></iframe>

é™„é€™å€‹é€£çµå®³æˆ‘å¯«é€™ç¯‡çš„æ™‚å€™ä¸€ç›´é‡æ’­

## é¡Œè§£

é€™è£¡å°±ç”¨ decompile ä¹‹å¾Œçš„ code ä¾†è¬›è§£ï¼Œæ²’æœ‰ IDA å¯ä»¥ç”¨ [Ghidra](https://ghidra-sre.org/)ï¼Œç§‘æ™®ä¸€ä¸‹ï¼ŒGhidra å”¸ä½œ[Gee-druh](https://github.com/NationalSecurityAgency/ghidra/wiki/Frequently-asked-questions#how-do-you-pronounce-ghidra)ï¼Œæˆ–æ˜¯ä½ å¯ä»¥å­¸æˆ‘å¿µ Costcoã€‚

åŸºæœ¬ä¸Š main åšçš„äº‹æƒ…å°±æ˜¯ [Zero padding](https://en.wikipedia.org/wiki/Padding_(cryptography)#Zero_padding)

```c main=
puts("My encryptor 0.1");
puts("I didn't implement the decryptor");
puts("So,you'll never find out my secret unless I am drunk");
__isoc99_scanf("%ms", &s);
v7 = strlen(s);
//v8 ç®—å‡ºæ¯”ç›®å‰è¼¸å…¥é•·åº¦å¤§çš„ 8 çš„å€æ•¸ï¼Œä¾‹å¦‚ 7 æœƒå¾—åˆ° 8ï¼Œ17 å¾—åˆ° 24
v8 = 8 * (v7 / 8 + 1);
//é‡æ–°åˆ†é…ä¸€å€‹å¤§å°ï¼Œè€Œä¸”è¤‡è£½æœ¬ä¾†çš„è¼¸å…¥ä¸Šå»
s = (char *)realloc(s, v8 + 1);
//å¤šå‡ºä¾†çš„éƒ¨åˆ†éƒ½æ”¾ 0ï¼Œå…¶å¯¦å°±æ˜¯åœ¨åš 0 padding
for ( i = v8; i >= v7; --i )
  s[i] = 0;
qmemcpy(v10, "dloGtroBedaJybuR", 16);
for ( j = 0; j < v8 / 8 + 1; ++j )
  sub_83A(s, v10);
for ( k = 0; k < v8; ++k )
  printf("%02hhx", (unsigned int)s[k]);
free(s);
```

æ²’ä»€éº¼ç‰¹åˆ¥çš„ï¼Œå¯ä»¥ç¹¼çºŒå¾€ä¸‹çœ‹ï¼š

```c sub_83A=
__int64 __fastcall sub_83A(unsigned int *a1, __int64 a2)
{
  __int64 result; // rax
  unsigned int i; // [rsp+1Ch] [rbp-14h]
  unsigned int v4; // [rsp+20h] [rbp-10h]
  unsigned int v5; // [rsp+24h] [rbp-Ch]
  unsigned int v6; // [rsp+28h] [rbp-8h]

  v4 = *a1;
  v5 = a1[1];
  v6 = 0;
  for ( i = 0; i <= 0x3F; ++i )
  {
    v4 += (((v5 >> 5) ^ (16 * v5)) + v5) ^ (*(_DWORD *)(4LL * (v6 & 3) + a2) + v6);
    v6 -= 0x61C88647;
    v5 += (((v4 >> 5) ^ (16 * v4)) + v4) ^ (*(_DWORD *)(4LL * ((v6 >> 11) & 3) + a2) + v6);
  }
  *a1 = v4;
  result = v5;
  a1[1] = v5;
  return result;
}
```

çœ‹èµ·ä¾†æ˜¯æŸç¨®åŠ å¯†æˆ–æ˜¯ hash ç®—æ³•ï¼Œå¦‚æœå¤ æ•æ„Ÿçš„è©±æ‡‰è©²æœƒæ³¨æ„åˆ°é€™å€‹ç®—æ³•è£¡é¢æœ‰ magic number å­˜åœ¨ï¼Œ`0x61C88647`ï¼Œä½†è¦æ³¨æ„ï¼Œé€™æ˜¯ IDA ç…§ variable type ä¿®æ­£ç”¢å‡ºçš„ pseudo codeï¼Œå›å»çœ‹ assemblyï¼Œæœƒç™¼ç¾å…¶å¯¦æ˜¯ï¼š

```x86asm 
mov     [rbp+var_4], 9E3779B9h
```

æœ¬ä¾†æ˜¯ `v6 += 0x9E3779B9`ï¼Œä½† IDA è¦ºå¾— `v6 -= 0x61C88647` æ¯”è¼ƒå¥½ï¼Œç¸½ä¹‹åªæ˜¯ 2's complementï¼Œå…¶å¯¦ä¸ç®¡å“ªä¸€å€‹éƒ½å¯ä»¥æ‰¾é—œéµç®—æ³• [TEA](https://en.wikipedia.org/wiki/Tiny_Encryption_Algorithm)ï¼Œä»”ç´°çœ‹ä¸€ä¸‹æœƒç™¼ç¾å…¶å¯¦æœ‰é»ä¸å¤ªä¸€æ¨£ï¼Œä½†æ‡‰è©²è¶³å¤ æ¨¡ä»¿å¯«å‡º decrypt çš„ç¨‹å¼äº†ï¼Œå°±åè½‰æ“ä½œè€Œå·²ï¼Œå¦‚æœæœ‰è€å¿ƒçˆ¬ä¸€ä¸‹ wiki æœƒç™¼ç¾é¡Œç›®å¯¦ä½œçš„ç®—æ³•æ˜¯ [XTEA](https://en.wikipedia.org/wiki/XTEA)ï¼Œç›´æ¥ç”¨ wiki ä¸Šçš„ decrypt å°±è¡Œäº†ï¼Œè¦æ³¨æ„çš„æ˜¯ main è£¡é¢å…¶å¯¦åªæœ‰åŠ å¯†ç¬¬ä¸€å¡Š blockï¼Œæ‰€ä»¥ç¬¬ä¸€å¡Šè¢«åŠ å¯†äº† 9 æ¬¡ï¼Œåªè¦è§£å¯†ç¬¬ä¸€å¡Šå°±å¥½äº†ï¼š

```c main=
puts("My encryptor 0.1");
puts("I didn't implement the decryptor");
puts("So,you'll never find out my secret unless I am drunk");
__isoc99_scanf("%ms", &s);
v7 = strlen(s);
v8 = 8 * (v7 / 8 + 1);
s = (char *)realloc(s, v8 + 1);
for ( i = v8; i >= v7; --i )
  s[i] = 0;
qmemcpy(v10, "dloGtroBedaJybuR", 16);
//---------------é€™è£¡æ°¸é åªåŠ å¯†ç¬¬ä¸€å¡Š block----------------
for ( j = 0; j < v8 / 8 + 1; ++j )
  sub_83A(s, v10);
//------------------------------------------------------
for ( k = 0; k < v8; ++k )
  printf("%02hhx", (unsigned int)s[k]);
free(s);
```

å› ç‚ºåªæœ‰ç¬¬ä¸€å¡Šæœ‰åŠ å¯†ï¼š

```python
#My encryptor 0.1
#I didn't implement the decryptor
#So,you'll never find out my secret unless I am drunk
#850a2a4d3fac148269726c5f673176335f6d335f55725f49475f346e645f746831735f31735f6d316e655f746572727974657272795f5f7d0000000000000000
In [1]: bytes.fromhex("850a2a4d3fac148269726c5f673176335f6d335f55725f49475f346e645f746831735f31735f6d316e655f746572727974657272795f5f7d0000000000000000")
Out[1]: b'\x85\n*M?\xac\x14\x82irl_g1v3_m3_Ur_IG_4nd_th1s_1s_m1ne_terryterry__}\x00\x00\x00\x00\x00\x00\x00\x00'
```

æ‰€ä»¥é€™è£¡å°±æœ‰ç¬¬äºŒå€‹è§£æ³•æ˜¯çˆ†æœ 3 byte çš„æ–‡å­—(`8 - len('AIS3{')`)ï¼Œè³½ä¸­ @bronson113 è·Ÿæˆ‘èªªä»–æœ‰éé æœŸè§£ï¼Œåªè¦æš´æœ 2 byteï¼Œæˆ‘é‚„ä»¥ç‚ºåˆå¯«çˆ› code ...ï¼Œé›–ç„¶æ˜¯çœŸçš„ code å¯«çˆ›æ‰æ•¢æ”¾é€™é¡Œï¼Œä¸ç„¶å¥½åƒæœ‰é»å¤ªé›£ï¼Œä¸çŸ¥é“è¦æŸ¥ magic number çš„äººæ‡‰è©²è§£ä¸å‡ºä¾†ï¼Œæœ¬ä¾†æ˜¯æƒ³å‡ºé‚£ç¨®åŠ å¯†å¯«éŒ¯çš„æ²’éŒ¯ï¼Œä½†æ€éº¼å‡ºå¥½åƒéƒ½æœ‰é»å¤ªé›£ï¼Œä¹‹å¾Œæ‰çŸ¥é“åŸä¾†å¤§å®¶æš´æœéƒ½æœ‰çŒœå­— = =ï¼Œå¥½ï¼Œæ©ï¼Œç¸½ä¹‹ä½ çŒœåˆ°é‚£å€‹å­—æ˜¯ girl å°±å¯ä»¥åªæš´æœ 2 byteï¼Œ[è–çµçŸ³ä¿éšªèµ·è¦‹è²·ä¸‰ä»¶](https://youtu.be/mVN-kdWxmfs?t=39)ï¼Œä¿éšªèµ·è¦‹æˆ‘éƒ½æœ 3 byteã€‚

```python bruteforce.py=
from subprocess import *
from string import *
from itertools import product

target = open("./flag",'rb').read()
for cipher in product(printable[:-5],repeat=3):
    plain = f"AIS3{{{''.join(cipher)}irl_g1v3_m3_Ur_IG_4nd_th1s_1s_m1ne_terryterry__}}".encode()
    p = check_output("./Long\ Island\ Iced\ Tea",input=plain,shell=True)
    if p == target:
        print(plain)
        break
```

ä¸éæœ€å¿«çš„è§£æ³•é‚„æ˜¯ç›´æ¥å¯« decryptï¼š

```c decrypt.c=
#include <stdlib.h>
#include <stdio.h>

//copy from wiki
void decipher(uint32_t v[2], uint32_t const key[4]) {
    unsigned int i;
    uint32_t v0=v[0], v1=v[1], delta=0x9E3779B9, sum=delta*64;
    for (i=0; i < 64; i++) {
        v1 -= (((v0 << 4) ^ (v0 >> 5)) + v0) ^ (sum + key[(sum>>11) & 3]);
        sum -= delta;
        v0 -= (((v1 << 4) ^ (v1 >> 5)) + v1) ^ (sum + key[sum & 3]);
    }
    v[0]=v0; v[1]=v1;
}

int main(){
    char key[] = "dloGtroBedaJybuR";
    char input[] = {0x85,0x0a,0x2a,0x4d,0x3f,0xac,0x14,0x82,0};

    for(int r = 0; r < 9 ; r++){
        decipher(input,key);
    }

    printf("%sirl_g1v3_m3_Ur_IG_4nd_th1s_1s_m1ne_terryterry__}",input);
}
```

> Flag: `AIS3{A!girl_g1v3_m3_Ur_IG_4nd_th1s_1s_m1ne_terryterry__}`

> è£œï¼šçœ‹å®Œ writeupï¼Œå¤§æ¦‚æ˜¯ä¸€åŠçš„äººç”¨æš´æœï¼Œä¸€åŠçš„äººæœ‰èªå‡ºä¾†æ˜¯ XTEAï¼Œå‡ºçš„ä¸éŒ¯ï¼Ÿ
> æ‰“æ¯”è³½çš„æ™‚å€™æœ‰é‡é rc4 ä½ç§»æ•…æ„å¯«éŒ¯è¦ä¿®ï¼Œæˆ–åœŸç‚®åŠ å¯†å¯«éŒ¯ä¹‹é¡çš„é¡Œç›®ï¼Œå¤§æ¦‚æœ‰å€‹å…©ä¸‰é¡Œï¼Œä½†è¦ºå¾—å‡ºåœ¨é€™è£¡å¥½åƒä¸å¤ªå¥½
> æœ€å¾Œç”¢äº†ä¸€é¡Œå¤§ä¾¿é¡ŒğŸ¤”ï¸

---

# ğŸŒ¹ La vie en rose

## é¡Œç›®æ•˜è¿°

> <Image src="./rose.jpg" alt="" />

## é¡Œè§£

ç¨å¾®é€†å‘çœ‹ä¸€ä¸‹æœƒç™¼ç¾ binary å‰é¢ä¸€ç›´ä½¿ç”¨ `_MEIPASS2` é€™å€‹å­—ä¸²ï¼Œæœƒè¢«æ‹¿å» call `GetEnvironmentVariableW` ä¹‹é¡çš„ APIï¼ŒæŸ¥ä¸€ä¸‹å°±å¯ä»¥ç™¼ç¾é€™å€‹æ˜¯ PyInstaller ä½¿ç”¨çš„ä¸€å€‹ç’°å¢ƒè®Šæ•¸ï¼ŒPyInstaller æ˜¯ä¸€å€‹å¯ä»¥æŠŠ python åŒ…æˆåŸ·è¡Œæª”çš„å·¥å…·ï¼ˆexeä»¥å¤–ä¹Ÿå¯ä»¥ï¼‰ï¼ŒåŸç†æ˜¯æŠŠ python compile æˆ bytecode ä¹‹å¾Œï¼ŒåŸ·è¡Œæª”åŸ·è¡Œæ™‚æœƒæŠŠ bytecode æŠ“å‡ºä¾†åŸ·è¡Œï¼Œä¸é›£æƒ³åˆ°æ‡‰è©²æœƒæœ‰å·¥å…·å¯ä»¥æŠŠæ±è¥¿æ‹‰å‡ºä¾†ï¼Œ[PyInstaller Extractor](https://sourceforge.net/projects/pyinstallerextractor/)ã€‚

æ‰€æœ‰çš„æ±è¥¿æœƒè¢«æŠ½å‡ºä¾†æ”¾é€² `La vie en rose.exe_extracted` è³‡æ–™å¤¾ï¼Œpyinstallerextractor.py æœƒå‘Šè¨´ä½  entry point æ˜¯å•¥ï¼š

```shell
pyinstxtractor.py:86: DeprecationWarning: the imp module is deprecated in favour of importlib; see the module's documentation for alternative uses
  import imp
[*] Processing La vie en rose.exe
[*] Pyinstaller version: 2.1+
[*] Python version: 38
[*] Length of package: 9518557 bytes
[*] Found 955 files in CArchive
[*] Beginning extraction...please standby
[+] Possible entry point: pyiboot01_bootstrap
[+] Possible entry point: pyi_rth__tkinter
[+] Possible entry point: pyi_rth_multiprocessing
[+] Possible entry point: rose
[*] Found 258 files in PYZ archive
[*] Successfully extracted pyinstaller archive: La vie en rose.exe
```

ä½†å¦‚æœå®ƒçµ¦éŒ¯ï¼Œä¹Ÿå¯ä»¥ç”¨ grep æ‰¾åˆ°ï¼Œå› ç‚º python bytecode çš„å­—ä¸²æ˜¯ raw dataï¼š

```shell
$ grep outland *
grep: PYZ-00.pyz_extracted: Is a directory
Binary file rose matches
```

æ‰€ä»¥æˆ‘å€‘æ¥ä¸‹ä¾†è¦åšçš„äº‹æƒ…æ˜¯ decompile rose.pycï¼Œé€™è£¡å¯ä»¥ç”¨ uncompyle6 ä¾†åšï¼Œä½†æ˜¯æœƒæœ‰éŒ¯èª¤è¨Šæ¯ï¼ŒåŸå› æ˜¯ pyc å°‘äº†ç‰ˆæœ¬ magic numberï¼Œå¾ˆå¥½ç†è§£ï¼Œå› ç‚º PyInstaller çŸ¥é“è‡ªå·±åœ¨é€™å€‹ binary ç”¨äº†ä»€éº¼ç‰ˆæœ¬ï¼Œæ‰€ä»¥ä»–å¯ä»¥æŠŠ magic number æ‹”æ‰ä¾†ç¯€çœç©ºé–“ï¼š

```python
uncompyle6 rose.pyc
Traceback (most recent call last):
  File "/usr/local/lib/python3.7/site-packages/xdis/load.py", line 168, in load_module_from_file_object
    float_version = magic_int2float(magic_int)
  File "/usr/local/lib/python3.7/site-packages/xdis/magics.py", line 399, in magic_int2float
    return py_str2float(magicint2version[magic_int])
KeyError: 227

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/bin/uncompyle6", line 8, in <module>
    sys.exit(main_bin())
  File "/usr/local/lib/python3.7/site-packages/uncompyle6/bin/uncompile.py", line 194, in main_bin
    **options)
  File "/usr/local/lib/python3.7/site-packages/uncompyle6/main.py", line 326, in main
    do_fragments,
  File "/usr/local/lib/python3.7/site-packages/uncompyle6/main.py", line 186, in decompile_file
    filename, code_objects
  File "/usr/local/lib/python3.7/site-packages/xdis/load.py", line 141, in load_module
    get_code=get_code,
  File "/usr/local/lib/python3.7/site-packages/xdis/load.py", line 176, in load_module_from_file_object
    % (ord(magic[0:1]) + 256 * ord(magic[1:2]), filename)
ImportError: Unknown magic number 227 in rose.pyc
```

ä½†æ˜¯å…¶å¯¦ python import æ±è¥¿çš„æ™‚å€™æ˜¯æœƒæª¢æŸ¥ magic number çš„ï¼Œæ‰€ä»¥ extract å‡ºä¾†çš„ library æ‡‰è©²éƒ½é‚„ç•™è‘— magic numberï¼š

```shell
$ xxd importlib.pyc | head
00000000: 550d 0d0a 0000 0000 0000 0000 e300 0000  U...............
00000010: 0000 0000 0000 0000 0000 0000 0008 0000  ................
```

æ‰€ä»¥å…¶å¯¦ä¹Ÿä¸éœ€è¦çŸ¥é“ç‰ˆæœ¬ï¼Œ å¯ä»¥ç›´æ¥æ‹¿åˆ° magic number `550d 0d0a`ã€‚
å‡è¨­ä¸çŸ¥é“é€™ä»¶äº‹æƒ…çš„è©±ï¼Œé‚£ç¾åœ¨è¦å…ˆçŸ¥é“ç‰ˆæœ¬æ˜¯ä»€éº¼ï¼Œè¦ç¢ºå®šç‰ˆæœ¬æœ‰å¹¾å€‹æ–¹æ³•ï¼ŒåŸ·è¡Œ binary å»çœ‹ä»–è¼‰äº†ä»€éº¼ dllï¼š

<Image src="./pythondll.png" alt="" />

æˆ–æ˜¯åƒå‰›å‰›ä¸€æ¨£ç›´æ¥ grepï¼Œä¸ç„¶ ls ä¹Ÿè¡Œï¼š

```shell
$ grep python *
Include\pyconfig.h:#                               pragma comment(lib,"python38_d.lib")
Include\pyconfig.h:#                               pragma comment(lib,"python3.lib")
Include\pyconfig.h:#                               pragma comment(lib,"python38.lib")

$ ls | grep python  
python38.dll
```

çŸ¥é“ç‰ˆæœ¬å¾Œï¼Œå¯ä»¥åœ¨ [cpython github](https://github.com/python/cpython/blob/3.8/Lib/importlib/_bootstrap_external.py#L261) æ‰¾åˆ° magic numberï¼š

```c _bootstrap_external.py=261
#     Python 3.8a1  3400 (move frame block handling to compiler #17611)
#     Python 3.8a1  3401 (add END_ASYNC_FOR #33041)
#     Python 3.8a1  3410 (PEP570 Python Positional-Only Parameters #36540)
#     Python 3.8b2  3411 (Reverse evaluation order of key: value in dict
#                         comprehensions #35224)
#     Python 3.8b2  3412 (Swap the position of positional args and positional
#                         only args in ast.arguments #37593)
#     Python 3.8b4  3413 (Fix "break" and "continue" in "finally" #37830)
```

ç¸½ä¹‹é€™è£¡å¯ä»¥ç›´æ¥æŠŠ importlib.pyc `550d 0d0a` è£œåˆ° rose.pyc å‰é¢å°±å¥½äº†ï¼Œä½†é‚„è¦å¦å¤–è£œä¸Š 12 byteï¼Œé€™æ¨£ marshal åç§»åˆ° 0x10 æ‰æœƒå°ï¼Œå…¶ä¸­åŒ…æ‹¬ timestamp è·Ÿ source sizeï¼Œä¸æ˜¯å¾ˆé‡è¦æ‰€ä»¥å°±éš¨ä¾¿æŠ“ä¸€æŠ“ä¹Ÿä¸Ÿé€²å»å°±å¥½äº†ï¼š

```console
head -c 16 PYZ-00.pyz_extracted/importlib.pyc | cat - rose.pyc > rose_ok.pyc
```

ç„¶å¾Œè©¦è©¦çœ‹ decompile æœƒé‡åˆ° bytecode éŒ¯èª¤ï¼š

```shell
$ uncompyle6 rose_ok.pyc
...
Parse error at or near `JUMP_FORWARD' instruction at offset 222
```

å•é¡Œå‡ºåœ¨ `222  JUMP_FORWARD` æƒ³è¦è·³å» `256  JUMP_BACK  182  'to 182'` ä½† uncompyle6 å‡ºäº†é»å•é¡Œï¼Œæˆ‘å€‘å¯ä»¥å˜—è©¦æŠŠ `JUMP_FORWARD   256` ç›´æ¥æ›¿æ›æˆ `JUMP_BACK 182`ï¼š

```python
 L.  35       220  JUMP_BACK           182  'to 182'
              222  JUMP_FORWARD        256  'to 256' # this line
            224_0  COME_FROM           218  '218'

 L.  37       224  LOAD_NAME                winsound
              226  LOAD_METHOD              Beep
              228  LOAD_NAME                floor
              230  LOAD_NAME                keytone
              232  LOAD_NAME                note
              234  LOAD_CONST               0
              236  BINARY_SUBSCR
              238  BINARY_SUBSCR
              240  CALL_FUNCTION_1       1  ''
              242  LOAD_CONST               200
              244  LOAD_NAME                note
              246  LOAD_CONST               1
              248  BINARY_SUBSCR
              250  BINARY_MULTIPLY  
              252  CALL_METHOD_2         2  ''
              254  POP_TOP
            256_0  COME_FROM           222  '222'
            256_1  COME_FROM           206  '206'
              256  JUMP_BACK           182  'to 182'
```

è¦ä¿®æ”¹ä»–æˆ‘å€‘è¦å…ˆæ‰¾åˆ°[JUMP_FORWARD](https://docs.python.org/2/library/dis.html#opcode-JUMP_FORWARD) çš„ opcode æ˜¯ä»€éº¼

```python
import dis
print(hex(dis.opname.index('JUMP_FORWARD')))
#0x6e
```

marshal opcode é–‹å§‹çš„åœ°æ–¹åœ¨ 0x2eï¼Œæ‰€ä»¥ç²¾æº–è¦ä¿®æ”¹çš„ä½ç½®æ˜¯ $0x2e + 222 = 0x10c$ï¼Œ 222 çš„æ—é‚Š `220  JUMP_BACK  182  'to 182'` æ­£å¥½æ˜¯æˆ‘å€‘è¦çš„æ“ä½œï¼Œå¯ä»¥ç›´æ¥è¤‡è£½è²¼ä¸Šï¼š

```
00000100: 6400 1900 640b 6b02 72e0 71b6 6e20 6500  d...d.k.r.q.n e.
#ä¿®æ”¹æˆ
00000100: 6400 1900 640b 6b02 72e0 71b6 71b6 6500  d...d.k.r.q.n e.
```

ç„¶å¾Œå°±å¯ä»¥ decompile äº†ï¼š

```shell
uncompyle6 rose_ok.pyc > rose.py  
```

ç›´æ¥ç”¨è¨»è§£ä¾†è§£é‡‹åœ¨å¹¹å˜›ï¼š

```python rose.py=
# uncompyle6 version 3.7.1
# Python bytecode 3.8 (3413)
# Decompiled from: Python 3.8.0 (default, Oct 28 2019, 16:14:01) 
# [GCC 8.3.0]
# Embedded file name: rose.py
# Size of source mod 2**32: 227 bytes
import winsound
from time import sleep
from math import floor

#### é€™è£¡å–®ç´”åœ¨ç®—ç´éµéŸ³é«˜ ####
keytone = {'a': 261.63}
pt = keytone['a']
for k in ('w', 's', 'e', 'd', 'f', 't', 'g', 'y', 'h', 'u', 'j', 'k', 'o', 'l', 'p',
          ';', "'", '[', ']', ' '):
    keytone[k] = pt * pow(2, 0.08333333333333333)
    pt = keytone[k]

print('Play some music to please me, despicable outlander....')
print("\n ________________________________________________________\n|  | | | |  |  | | | | | |  |  | | | |  |  | | | | | |  |\n|  | | | |  |  | | | | | |  |  | | | |  |  | | | | | |  |\n|  |w| |e|  |  |t| |y| |u|  |  |o| |p|  |  |[| | | | |  |\n|  |_| |_|  |  |_| |_| |_|  |  |_| |_|  |  |_| |_| |_|  |\n|   |   |   |   |   |   |   |   |   |   |   |   |   |   |\n| a | s | d | f | g | h | j | k | l | ; | ' | ] |   |   |\n|___|___|___|___|___|___|___|___|___|___|___|___|___|___|\n")


notes = input()
play = [['-', 1]]
for note in notes:
    if note == play[(-1)][0]:
        play[(-1)][1] += 1
    else:
        play.append([note, 1])

#### ç©ºç™½æ˜¯ä¼‘æ­¢ç¬¦ï¼Œ- ç”¨ä¾†æŠŠéŸ³ç¬¦åˆ†æˆå…©çµ„ hh-hh æ˜¯å…©å€‹4åˆ†éŸ³ç¬¦ hhhh æ˜¯ä¸€å€‹2åˆ†éŸ³ç¬¦ ####
for note in play:
    if note[0] == ' ':
        sleep(0.2)
    elif note[0] == '-':
        continue
    else:
        winsound.Beep(floor(keytone[note[0]]), 200 * note[1]) # ç™¼å‡ºè²éŸ³


result = []
notes = list(map(ord, notes))

#### å…ˆæŠŠå…©å€‹ç›¸é„°çš„éŸ³ç¬¦ç›¸åŠ çš„å€¼æ”¾é€² result ####
for i in range(len(notes) - 1):
    result.append(notes[i] + notes[(i + 1)])

#### å…ˆæŠŠå…©å€‹ç›¸é„°çš„éŸ³ç¬¦ç›¸æ¸›çš„å€¼æ”¾é€² result ####
for i in range(len(notes) - 1):
    result.append(notes[i] - notes[(i + 1)])

#### result è¦ç­‰æ–¼ constraintï¼Œè¡¨ç¤ºè¼¸å…¥çš„ notes å°±æ˜¯ keyï¼Œä¾†æ‹¿ xor secret æœƒå°å‡º flagï¼Œæ‰€ä»¥æ²’è¾¦æ³•ç¹éï¼Œå¿…é ˆè¦çŸ¥é“ notes æ˜¯ä»€éº¼ ####
constraint = [..ç•¥..]
if result == constraint:
    secret = [..ç•¥..]
    flag = ''.join(map(chr, [secret[i] ^ notes[(i % len(notes))] for i in range(len(secret))]))
    print('That sounds good... I like to write the lyric for it')
    print(flag)
else:
    print('I said music, that sounds like diarrhea')
input()
# okay decompiling rose_ok.pyc

```

çœ‹åˆ°é€™è£¡ä¸é›£ç™¼ç¾å…¶å¯¦å°±æ˜¯åœ¨è§£è¯ç«‹æ–¹ç¨‹å¼ï¼Œèˆ‰ä¾‹ä¾†èªªï¼Œ`constraint[0]` æ˜¯ `notes[0]+notes[1]` è·Ÿ `constraint[120]` æ˜¯ `notes[0]-notes[1]` çš„å€¼ï¼Œæœ‰å”¯ä¸€è§£ï¼Œè€Œä¸”æˆ‘å€‘çŸ¥é“æ¨‚è­œæ‡‰è©²æœ‰ 121 å€‹ noteï¼Œå› ç‚º `len(constraint)=240`ï¼š

```python solve_note.py=
#!/usr/bin/env python3
constraint = [216, 219, 222, 219, 216, 219, 222, 219, 216, 219, 222, 202, 150, 167, 219, 219, 216, 219, 222, 219, 216, 219, 222, 219, 216, 219, 222, 202, 150, 167, 219, 219, 216, 219, 222, 219, 216, 219, 222, 219, 216, 219, 222, 202, 150, 167, 219, 219, 216, 219, 222, 217, 212, 210, 208, 210, 212, 210, 208, 136, 140, 216, 219, 222, 219, 216, 219, 222, 219, 216, 219, 222, 202, 150, 167, 219, 219, 216, 219, 222, 219, 216, 219, 222, 219, 216, 219, 222, 217, 217, 219, 167, 150, 182, 199, 216, 219, 222, 219, 216, 212, 208, 208, 208, 149, 149, 210, 217, 219, 167, 150, 182, 199, 216, 219, 222, 219, 216, 211, 206, 0, -3, 0, 3, 0, -3, 0, 3, 0, -3, 0, 20, 32, -49, -3, 3, 0, -3, 0, 3, 0, -3, 0, 3, 0, -3, 0, 20, 32, -49, -3, 3, 0, -3, 0, 3, 0, -3, 0, 3, 0, -3, 0, 20, 32, -49, -3, 3, 0, -3, 0, 5, 0, 2, 0, -2, 0, 2, 0, 72, -76, 0, -3, 0, 3, 0, -3, 0, 3, 0, -3, 0, 20, 32, -49, -3, 3, 0, -3, 0, 3, 0, -3, 0, 3, 0, -3, 0, 5, -5, 3, 49, -32, 0, -17, 0, -3, 0, 3, 0, 4, 0, 0, 0, 59, -59, -2, -5, 3, 49, -32, 0, -17, 0, -3, 0, 3, 0, 5, 0]

length = len(constraint)//2
notes = [ (constraint[i]+constraint[length+i])//2 for i in range(length)] + [notes[-1]-constraint[-1]]
# bytes(notes) = b'lloolloolloo[;lolloolloolloo[;lolloolloolloo[;lolloojjhhjjhh lloolloolloo[;lolloolloolloojol;[[lloollhhhh-hjol;[[lloollg'
secret = [62, 9, 11, 79, 0, 5, 4, 10, 76, 30, 0, 28, 62, 72, 76, 9, 5, 0, 3, 28, 76, 1, 22, 79, 8, 30, 10, 14, 54, 72, 102, 46, 2, 8, 79, 13, 30, 5, 1, 8, 31, 76, 2, 10, 123, 79, 3, 79, 24, 4, 10, 79, 26, 6, 9, 11, 15, 74, 17, 7, 85, 76, 30, 10, 28, 24, 102, 56, 7, 5, 24, 10, 79, 50, 72, 76, 12, 3, 0, 11, 79, 13, 2, 11, 79, 13, 0, 24, 14, 19, 28, 76, 66, 62, 58, 30, 2, 6, 1, 11, 102, 42, 29, 26, 12, 72, 6, 15, 11, 76, 89, 34, 123, 13, 76, 29, 0, 21, 13, 11, 71, 24, 9, 28, 27, 102, 46, 3, 14, 15, 7, 79, 27, 51, 94, 76, 13, 9, 13, 28, 27, 76, 8, 10, 28, 15, 9, 1, 11, 40, 27, 10, 29, 3, 1, 79, 28, 4, 13, 11, 0, 27, 31, 101, 54, 62, 87, 0, 0, 27, 76, 13, 10, 11, 31, 28, 17, 74, 8, 29, 26, 78, 31, 102, 40, 0, 0, 8, 101, 14, 2, 8, 79, 45, 15, 108, 76, 9, 76, 0, 79, 14, 76, 11, 79, 6, 76, 31, 79, 46, 74, 38, 76, 104, 123, 104, 76, 23, 27, 7, 93, 31, 55, 14, 4, 92, 74, 55, 24, 10, 8, 100, 55, 50, 7, 95, 48, 29, 3, 31, 84, 20, 51, 10, 94, 3, 0, 31, 48, 27, 13, 93, 24, 14, 53, 70]
flag = ''.join(map(chr,[ secret[i]^notes[i%len(notes)]  for i in range(len(secret))]))
print(flag)
#Red like roses fills my dreams
#And brings me to the place you rest
#White is cold and always yearning
#Burdened by a royal test
#Black the beast descends from shadows
#Yellow beauty burns
#Gold
#and BTW f l a g i s A I S 3 {th1s_fl4g_red_lik3_ros3s_f1lls_ta1wan}
```

> Flag: `AIS3{th1s_fl4g_red_lik3_ros3s_f1lls_ta1wan}`

ä»¥é˜²è¬ä¸€ä½ æƒ³çŸ¥é“é€™ç´è­œæ˜¯é‚£é¦–ï¼š

<iframe src="https://www.youtube.com/embed/pYW2GmHB5xs"></iframe>

---

# ğŸ‰ Uroboros

## é¡Œç›®æ•˜è¿°

> ä½ å¥½å•Šæ„›å¾·è¯å¤§å“¥å“¥ï¼ŒçœŸçš„æ²’æƒ³åˆ°ä½ å¯ä»¥åˆ°ç¬¬äºŒåäº”å±¤ä¾†å‘¢ï¼
> ä¸éå°±åˆ°é€™è£¡ç‚ºæ­¢äº†ï¼Œ
> æ¥ä¸‹ä¾†å°±ç”±æˆ‘ åé‡åŠ›ä¸‰é ­é–éˆåº·å¦®Â·è§£æ”¾Â·ç·‹ç´… ä¾†åšä½ çš„å°æ‰‹!
> <Image src="./connie.png" alt="" />

å‡ºé€™é¡Œæ‰ç™¼ç¾ï¼Œé€™å€‹ emoji ä¹Ÿå¤ªå¸¥äº†ã„…ï¼Œå…ƒæ°£å½ˆï¼Ÿï¼Ÿï¼Ÿ

<Image src="./dragon_1f409.png" alt="" />

ç„¶å¾Œå¯« blog æ‰ç™¼ç¾ï¼Œæˆ‘ cout å­—ä¸²çš„åœ°æ–¹è¿´åœˆå¯«éŒ¯äº†ğŸ¤”ï¸ï¼Œå°‘å°ä¸€å€‹æ‹‰ï¼Œå“ˆå“ˆï¼Œä¸éå‰›å¥½æ²’è¼¸å…¥è¸©åˆ°é‚£å€‹é»ï¼Œç¬‘åˆ°ä¸è¡Œã€‚

## é¡Œè§£

æœ‰ä½¿ç”¨ structure çš„ C++ é€†å‘é¡Œï¼Œä»”ç´°çœ‹å¯ä»¥ç™¼ç¾ï¼Œä¸€é–‹å§‹åšäº†ä¸€å€‹ circular double linked listï¼Œæ•´å€‹ç’°çš„é•·åº¦æ˜¯ 314ï¼ŒåŸæœ¬çš„ code çœ‹èµ·ä¾†åƒæ˜¯é€™æ¨£ï¼š

```c source.c=15
    node* ring = new node;
    ring->prev = ring;
    ring->next = ring;
    ring->idx = 0;
    node* work = ring;

    for(int i = 0 ; i < 313 ; i ++){
        node* temp = new node;
        temp->idx = 0;
        temp->next = work->next;
        temp->prev = work;
        work->next = temp;
        work = temp;
    }
```

ç•«å‡ºä¾†é•·é€™æ¨£ï¼š

```mermaid
stateDiagram
dot:"..."
[*] --> node0
node0 --> node1
node1 --> node2
node2 --> dot
dot --> node313
node313 --> node0
```

decompile å¾Œ C++ é•·å¾—æ¯”è¼ƒé›£çœ‹æ‡‚ä¸€é»ï¼Œå¤§è‡´æ˜¯é€™æ¨£ï¼š

```c
// cout << "Only state alchemists are entitled to know the forbidden secret, show me that you are" << endl;
// å¦‚æœä½ å° c++ æœ‰é»èªè­˜çš„è©± cout å…¶å¯¦æœƒå›å‚³ ostreamï¼Œæ‰€ä»¥ v3 æ˜¯ç”¨ä¾†ç¹¼çºŒä¸² endl ç”¨çš„
v3 = std::operator<<<std::char_traits<char>>(&std::cout,"Only state alchemists are entitled to know the forbidden secret, show me that you are");
std::ostream::operator<<(v3, &std::endl<char,std::char_traits<char>>);

// string v19;
std::__cxx11::basic_string<char,std::char_traits<char>,std::allocator<char>>::basic_string(v19);
// cin >> v19;
std::operator>><char>(&std::cin, v19);

// std::string::iterator v13 = v19.begin();
v13 = std::__cxx11::basic_string<char,std::char_traits<char>,std::allocator<char>>::begin(v19);
// std::string::iterator v14 = v19.end()
v14 = std::__cxx11::basic_string<char,std::char_traits<char>,std::allocator<char>>::end(v19);
// while v13 != v14 é€™å€‹è¿´åœˆæœƒæŠŠè¼¸å…¥çš„æ¯å€‹å­—éƒ½æ‹¿å‡ºä¾†
while ( (unsigned __int8)__gnu_cxx::operator!=<jstmt_t **,std::vector<jstmt_t *>>(&v13, &v14) )
  {
    // v12 = *v13; æ‹¿å‡ºç•¶å‰çš„ char
    v12 = *(char *)sub_21E6((__int64)&v13);
    v15 = v16;
    // åœ¨ç’°ä¸Šæ‰¾åˆ°ç¬¬ char*7 å€‹ nodeï¼Œ
    for ( j = 0; j < 7 * v12; ++j )
      v15 = v15->next;
    // æŠŠè‡ªå·±çš„å€¼è¨˜éŒ„ä¸Šå»ï¼Œä½†æŠŠåŸæœ¬çš„å€¼ << 6 ä¾†ä¿ç•™é‡è¤‡çš„å­—
    v15->value = v9++ + (v15->value << 6);
    // v13++;
    sub_21C6(&v13);
  }
```

## å­¸é™¢æ´¾è§£æ³• (?)

æ‰€ä»¥ input çš„æ¯å€‹å­—æœƒæŒ‰ç…§é †åºè¢«æ¨™è¨˜åœ¨ç’°ä¸Šï¼Œå…¶å¯¦å°±æ˜¯å–æ¨¡çš„æ¦‚å¿µï¼Œå‡è¨­è¼¸å…¥`A`ï¼Œå°±æœƒåœ¨ç’°ä¸Šé¢èµ° `ord('A')*7 = 65*7 = 455` æ­¥ï¼Œä½†æ˜¯å› ç‚ºåªæœ‰ 314 å€‹é»ï¼ˆ0~313ï¼‰æ‰€ä»¥æˆ‘å€‘æœƒèµ°åˆ° 141 è™Ÿ nodeï¼š
$$65*7=455 \\ 455\%314=141$$
åˆå› ç‚º 7 è·Ÿ 314 äº’è³ªï¼Œæ‰€ä»¥æˆ‘å€‘å¯ä»¥ç›´æ¥åšé€†é‹ç®—å¾—åˆ°æ¯ä¸€å€‹ä½ç½®æ˜¯ä»€éº¼ï¼Œä¾‹å¦‚å‰›å‰›çš„`A`æˆ‘å€‘å¯ä»¥å¾ 141 é€†æ¨ï¼š
$$?*7\equiv 141\mod 314\\?\equiv 141*7^\{-1}\mod 314\\141*45\mod314\\\text\{(7 åœ¨ mod 314 ä¸‹çš„æ¨¡åå…ƒç´ æ˜¯ 45 å¯ä»¥åƒè€ƒ exgcd)}\\25418\equiv65\mod314$$
æ¨å‡ºåŸæœ¬çš„å­—æ˜¯`chr(65)='A'`ï¼Œç…§é€™æ¨£å°±å¯ä»¥å¯«è…³æœ¬äº†ï¼š

```python solve.py=
target = "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 511847092 0 0 0 0 0 0 48 0 0 0 0 0 0 0 40984114273074 0 0 0 0 0 280 0 0 0 0 0 0 26022 26 0 0 0 0 0 0 2035 0 0 0 0 0 0 15 0 0 0 0 0 0 53 0 0 0 0 0 0 47 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 42350 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 40 0 0 0 0 0 0 29201 0 0 0 0 0 0 805 0 0 0 0 0 1 939 0 0 0 0 0 0 13 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 7739889 0 0 0 0 0 0 1251 0 0 0 0 0 0 45 0 0 0 0 0 0 2950300 0 0 0 0 0 2 23 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 54 0 0 0 0 0 0 0 0 0 0 0 0 0 5 0 0 0 0 0 0 0 0 0 0 0 0 0 55 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 3 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0".split(' ')

flag = ['']*100

for number,value in enumerate(map(int,target)):
    while value :
        idx = value&0b111111 #åªæ‹¿æœ€ä½6ä½ï¼Œå› ç‚º Uroboros æ¯æ¬¡åŠ æ–°çš„å€¼æœƒ << 6
        flag[idx] = chr((number*45)%314)
        value = value >> 6
print(''.join(flag))
```

> Flag: `AIS3{4ll_humonculus_h4v3_a_ur0b0r0s_m4rk_0n_the1r_b0dy}`

ä½†ä¹Ÿå¯ä»¥æŠŠæ¯å€‹ printable éƒ½å…ˆ `*7%314` å°±å¯ä»¥çŸ¥é“å°æ‡‰çš„å€¼äº†æ‹‰

## é‡ç¸æµè§£æ³• (?)

æœ¬ä¾†æ²’æœ‰å°ä½¿ç”¨è€…è¼¸å…¥æ‰€ç”¢ç”Ÿçš„ç’°é•·æ€æ¨£ï¼Œä½†è¦ºå¾—é€™æ¨£ debug é›£åº¦å¥½åƒæœ‰é»èºå‡ï¼Œæ‰€ä»¥æœ€å¾Œé‚„æ˜¯å°å‡ºä¾†äº†ï¼Œæ‰€ä»¥é€™è£¡å°±æœ‰å¦å¤–ä¸€å€‹è§£æ³•ï¼ˆæˆ‘å¥½åƒæ²’çœ‹åˆ°æœ‰äººé€™æ¨£è§£ï¼‰ï¼Œå°±æ˜¯å¯ä»¥å…ˆé»‘ç®±æ¸¬è©¦çŸ¥é“è¼¸å…¥æ˜¯æ€éº¼æ¨£å‘ˆç¾åœ¨ç’°ä¸Šé¢çš„ï¼Œä¹‹å¾Œå°±å¯ä»¥é€²è¡Œ byte by byte çˆ†ç ´ï¼Œæ‹¿ä¾†è·Ÿæ­£è§£æ¯”æ¯”çœ‹å°±çŸ¥é“ç•¶å‰é€™ä¸€ byte å°ä¸å°äº†ã€‚
