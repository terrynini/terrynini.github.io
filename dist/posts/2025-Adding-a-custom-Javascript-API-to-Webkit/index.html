<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.11.1"><title>NiNi's Den. CyberSec Blog</title><link rel="stylesheet" href="/src/styles/cyber-space-theme.css"><link rel="stylesheet" href="/src/styles/light-theme.css"><style>.post-image-wrapper[data-astro-cid-no5unav3]{margin:1.5em auto;max-width:100%;position:relative;display:inline-block}.post-image-wrapper[data-astro-cid-no5unav3]:before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(var(--color-accent-r),var(--color-accent-g),var(--color-accent-b),1);mix-blend-mode:color;pointer-events:none;transition:opacity .3s ease-in-out;opacity:1}.post-image-wrapper[data-astro-cid-no5unav3]:hover:before{opacity:0}.post-image[data-astro-cid-no5unav3]{display:block;max-width:100%;height:auto;border:1px solid var(--color-border);box-shadow:0 0 10px #0009;transition:all .3s ease-in-out}.post-image[data-astro-cid-no5unav3]:hover{filter:brightness(1) contrast(1);box-shadow:0 0 15px rgba(var(--color-accent-r),var(--color-accent-g),var(--color-accent-b),.7)}
</style></head> <body style="margin: 0; padding-top: 60px;"> <script>
            // Apply theme from localStorage immediately to prevent FOUC
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.add('theme-light'); // Default theme
                localStorage.setItem('theme', 'theme-light');
            }
        </script> <button id="theme-toggle" class="theme-toggle-btn">
切換主題
</button> <nav class="main-nav"> <ul class="main-nav-list"> <li class="main-nav-item"><a href="/" class="main-nav-link">Home</a></li> <li class="main-nav-item"><a href="/about" class="main-nav-link">About</a></li> </ul> </nav>  <div class="article-page-wrapper"> <aside class="author-hud"> <div class="author-hud-content glitchable"> <img src="//avatars2.githubusercontent.com/u/15998206" alt="NiNi's avatar" class="author-avatar"> <div class="author-info"> <h4><a href="https://balsn.tw/">NiNi</a></h4> <p class="title">Security Researcher</p> </div> </div> </aside> <div class="container"> <article class="post-content"> <h1>2025::Adding a custom Javascript API to Webkit</h1> <p class="post-meta">Published: 2025-07-09 | Category: WebKit</p> <p>Say if we want to add a custom function so that we can terminate the whole browser from JS by calling <code>window.NiNiTest.quit</code>, what should we do?</p>
<p>First, we have to create files <code>NiNiTest.idl</code> and <code>NiNiTest.h</code> under the WebCore project:</p>
<pre><code class="language-idl">//
//  NiNiTest.idl
//  WebCore
//
//  Created by NiNi on 2025/6/30.
//

[
    Exposed=Window
] interface NiNiTest {
    [CallWith=CurrentDocument] static undefined quit();
};
</code></pre>
<pre><code class="language-cpp">//
//  NiNiTest.h
//  WebCore
//
//  Created by NiNi on 2025/6/30.
//

#pragma once


#include &quot;Document.h&quot;
#include &quot;Chrome.h&quot;
#include &quot;ChromeClient.h&quot;
#include &lt;wtf/Ref.h&gt;
#include &lt;wtf/RefCounted.h&gt;

namespace WebCore {

class NiNiTest : public RefCounted&lt;NiNiTest&gt;{
    public:
        static Ref&lt;NiNiTest&gt; create(ScriptExecutionContext&amp; context)
        {
            return adoptRef(*new NiNiTest(downcast&lt;Document&gt;(context)));
        }
        static ExceptionOr&lt;void&gt; quit(Document&amp; document)
        {
            if (auto* page = document.page())
                page-&gt;chrome().client().requestBrowserQuit();
            return { };
        }
    
    private:
        NiNiTest(Document&amp;);
    
        Ref&lt;Document&gt; m_document;
    };
}
</code></pre>
<p>Appending a new line in <code>Source/WebCore/Sources.txt</code>:</p>
<pre><code>JSNiNiTest.cpp
</code></pre>
<p>Add <code>$(WebCore)/NiNiTest.idl</code> to <code>JS_BINDING_IDLS</code> in  <code>Source/WebCore/DerivedSources.txt</code></p>
<pre><code class="language-diff">JS_BINDING_IDLS := \
+    $(WebCore)/NiNiTest.idl \
</code></pre>
<p>The webkit will generate corresponding <code>JSNiNiTest.cpp</code> and <code>JSNiNiTest.cpp</code> for us.</p>
<p>Now, because the <code>requestBrowserQuit</code> in <code>page-&gt;chrome().client().requestBrowserQuit();</code>  doesn’t exist, we have to implement that function to make it come true. We add a virutal function in class <code>ChromeClient</code> in <code>/Source/WebCore/page/ChromeClient.h</code></p>
<pre><code class="language-diff">class ChromeClient {
public:
+    virtual void requestBrowserQuit() { }
</code></pre>
<p>Then overwrite it in the derived class <code>WebChromeClient</code> in <code>Source/WebKit/WebProcess/WebCoreSupport/WebChromeClient.h</code></p>
<pre><code class="language-diff">class WebChromeClient final : public WebCore::ChromeClient {
    WTF_MAKE_TZONE_ALLOCATED(WebChromeClient);
public:
    WebChromeClient(WebPage&amp;);
    ~WebChromeClient();

    WebPage* page() const { return m_page.get(); }
+    void requestBrowserQuit() final; 
</code></pre>
<p>and <code>Source/WebKit/WebProcess/WebCoreSupport/WebChromeClient.cpp</code>.</p>
<pre><code class="language-diff">+void WebChromeClient::requestBrowserQuit()
+{
+    m_page-&gt;send(Messages::WebPageProxy::RequestBrowserQuit());
+}
</code></pre>
<p>We try to send a message through IPC to <code>WebPageProxy</code>, same, there is nothing can handle this message or even send it.</p>
<p>Adding a new function to class <code>WebPageProxy</code> in <code>Source/WebKit/UIProcess/WebPageProxy.h</code></p>
<pre><code class="language-diff">class WebPageProxy final : public API::ObjectImpl&lt;API::Object::Type::Page&gt;, public IPC::MessageReceiver {
public:
    static Ref&lt;WebPageProxy&gt; create(PageClient&amp;, WebProcessProxy&amp;, Ref&lt;API::PageConfiguration&gt;&amp;&amp;);
    virtual ~WebPageProxy();

    void ref() const final { API::ObjectImpl&lt;API::Object::Type::Page&gt;::ref(); }
    void deref() const final { API::ObjectImpl&lt;API::Object::Type::Page&gt;::deref(); }

    USING_CAN_MAKE_WEAKPTR(IPC::MessageReceiver);
+    void requestBrowserQuit();
</code></pre>
<p>and <code>Source/WebKit/UIProcess/WebPageProxy.cpp</code></p>
<pre><code class="language-diff">+void WebPageProxy::requestBrowserQuit()
+{
+    m_uiClient-&gt;runBrowserQuit(this);
+}
</code></pre>
<p>Adding it to the <code>Source/WebKit/UIProcess/WebPageProxy.messages.in </code></p>
<pre><code class="language-diff">messages -&gt; WebPageProxy {
+    RequestBrowserQuit()
    # UI messages
</code></pre>
<p>Actually close the application in by firstly adding a virtual function in  in <code>/Source/WebKit/UIProcess/API/APIUIClient.h</code></p>
<pre><code class="language-diff">class UIClient {
    WTF_MAKE_TZONE_ALLOCATED(UIClient);
public:
    virtual ~UIClient() { }

+    virtual void runBrowserQuit(WebKit::WebPageProxy*) { }
</code></pre>
<p>Overwriting it in <code>UIClient</code> in <code>Source/WebKit/UIProcess/Cocoa/UIDelegate.h</code></p>
<pre><code class="language-diff">namespace WebKit {

enum class TapHandlingResult : uint8_t;

class UIDelegate : public CanMakeWeakPtr&lt;UIDelegate&gt; {
    WTF_MAKE_TZONE_ALLOCATED(UIDelegate);
public:
    explicit UIDelegate(WKWebView *);
    ~UIDelegate();

    void ref() const;
    void deref() const;

#if ENABLE(CONTEXT_MENUS)
    std::unique_ptr&lt;API::ContextMenuClient&gt; createContextMenuClient();
#endif
    std::unique_ptr&lt;API::UIClient&gt; createUIClient();

    RetainPtr&lt;id &lt;WKUIDelegate&gt; &gt; delegate();
    void setDelegate(id &lt;WKUIDelegate&gt;);

private:
#if ENABLE(CONTEXT_MENUS)
    class ContextMenuClient : public API::ContextMenuClient {
        WTF_MAKE_TZONE_ALLOCATED(ContextMenuClient);
    public:
        explicit ContextMenuClient(UIDelegate&amp;);
        ~ContextMenuClient();

    private:
        // API::ContextMenuClient
        void menuFromProposedMenu(WebPageProxy&amp;, NSMenu *, const ContextMenuContextData&amp;, API::Object*, CompletionHandler&lt;void(RetainPtr&lt;NSMenu&gt;&amp;&amp;)&gt;&amp;&amp;) override;

        WeakPtr&lt;UIDelegate&gt; m_uiDelegate;
    };
#endif

    class UIClient : public API::UIClient, public CanMakeWeakPtr&lt;UIClient&gt; {
        WTF_MAKE_TZONE_ALLOCATED(UIClient);
    public:
        explicit UIClient(UIDelegate&amp;);
        ~UIClient();
+        void runBrowserQuit(WebPageProxy*) final; 
</code></pre>
<p>and <code>Source/WebKit/UIProcess/Cocoa/UIDelegate.mm</code></p>
<pre><code class="language-diff">+void UIDelegate::UIClient::runBrowserQuit(WebPageProxy*)
+{
+    [NSApp terminate:nil];
+}
</code></pre>
<p>If the webkit fail to find <code>JSNiNiTest.h</code>, try to clean to build folder of WebCore then try again, that should solve the issue.</p>
<div class="post-image-wrapper aug-border aug-br--inset aug-bl--inset aug-tr--inset aug-tl--inset" data-astro-cid-no5unav3> <img src="/_astro/fail.CfmMYl8z_180QBu.webp" alt data-astro-cid-no5unav3="true" loading="lazy" decoding="async" fetchpriority="auto" width="972" height="222" class="post-image"> </div> 
<h2 id="refs">Refs</h2>
<ul>
<li><a href="https://github.com/WebKit/WebKit/wiki/Adding-a-New-WebIDL-Interface">Adding a New WebIDL Interface · WebKit/WebKit Wiki</a></li>
</ul> </article> </div> <aside class="article-outline-hud" data-augmented-ui="tl-clip tr-clip br-clip bl-clip border"> <div class="article-outline-hud-content glitchable"> <h2>文章大綱</h2> <nav> <ul> <li> <a href="#refs">Refs</a> </li> </ul> </nav> </div> </aside> </div> <div id="persistent-notes-overlay"></div> <script>
        document.addEventListener('DOMContentLoaded', () => {
            const highlightElements = document.querySelectorAll('.persistent-highlight');
            const notesOverlay = document.getElementById('persistent-notes-overlay');
            const containerElement = document.querySelector('.container');

            const positionNotes = () => {
                notesOverlay.innerHTML = ''; 
                if (!containerElement) return; 

                
                if (window.innerWidth > 1024) {
                    const containerRect = containerElement.getBoundingClientRect();
                    const noteWidth = 220; 
                    const margin = 60; 

                    highlightElements.forEach(highlightEl => {
                        const noteId = highlightEl.dataset.noteId;
                        const noteText = highlightEl.dataset.noteText; 

                        const rect = highlightEl.getBoundingClientRect();

                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'persistent-note-item';
                        noteDiv.setAttribute('data-note-id', noteId);
                        noteDiv.innerHTML = `<p>${noteText}</p>`;

                        
                        noteDiv.style.position = 'absolute'; 
                        noteDiv.style.top = `${rect.top}px`; 
                        noteDiv.style.left = `${containerRect.left - noteWidth - margin}px`; 
                        noteDiv.style.width = `${noteWidth}px`;

                        notesOverlay.appendChild(noteDiv);

                        
                        highlightEl.addEventListener('mouseenter', () => {
                            noteDiv.classList.add('sci-fi-active');
                        });
                        highlightEl.addEventListener('mouseleave', () => {
                            noteDiv.classList.remove('sci-fi-active');
                        });

                        
                        noteDiv.addEventListener('mouseenter', () => {
                            highlightEl.classList.add('highlight-active');
                        });
                        noteDiv.addEventListener('mouseleave', () => {
                            highlightEl.classList.remove('highlight-active');
                        });
                    });
                }
            };

            
            positionNotes();

            
            window.addEventListener('scroll', positionNotes);
            window.addEventListener('resize', positionNotes);
        });
    </script> <style>
        
        .post-content img {
            max-width: 100%;
            height: auto;
            display: block; 
            margin: 0 auto; 
        }

        

        #persistent-notes-overlay {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; 
            z-index: 5; 
        }

        @media (max-width: 1200px) {
            #persistent-notes-overlay {
                display: none; 
            }
        }

        .persistent-note-item {
            pointer-events: auto; 
            
        }
    </style>  <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="position: absolute; top: -9999px; left: -9999px;"> <defs> <filter id="dist-01"> <feTurbulence id="turbulence" baseFrequency="0.02" numOctaves="8" result="noise" seed="0"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-02"> <feTurbulence id="turbulence" baseFrequency="0.2" numOctaves="8" result="noise" seed="1"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-03"> <feTurbulence id="turbulence" baseFrequency="0.01" numOctaves="6" result="noise" seed="2"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-04"> <feTurbulence id="turbulence" baseFrequency="0.01" numOctaves="6" result="noise" seed="2" type="fractalNoise"></feTurbulence> <feDisplacementMap id="displacement" in="SourceGraphic" in2="noise" scale="6"></feDisplacementMap> </filter> <!-- Additional Glitch Filters for more variety --> <filter id="dist-05"> <feTurbulence baseFrequency="0.05" numOctaves="4" result="noise" seed="3"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="10"></feDisplacementMap> </filter> <filter id="dist-06"> <feTurbulence baseFrequency="0.1" numOctaves="2" result="noise" seed="4"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="8"></feDisplacementMap> </filter> <filter id="dist-07"> <feTurbulence baseFrequency="0.03" numOctaves="6" result="noise" seed="5" type="fractalNoise"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="12"></feDisplacementMap> </filter> <filter id="dist-08"> <feTurbulence baseFrequency="0.08" numOctaves="3" result="noise" seed="6"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="5"></feDisplacementMap> </filter> </defs> </svg> <script>
            document.addEventListener('DOMContentLoaded', () => {
                const glitchableElements = document.querySelectorAll('.glitchable');
                const filters = ['dist-01', 'dist-02', 'dist-03', 'dist-04', 'dist-05', 'dist-06', 'dist-07', 'dist-08'];

                glitchableElements.forEach(el => {
                    function applyGlitch() {
                        const randomFilterId = filters[Math.floor(Math.random() * filters.length)];
                        const glitchDuration = 0.08//Math.random() * (0.1 - 0.05) + 0.05; // Glitch lasts between 0.05 and 0.1 seconds
                        const delayBeforeNextGlitch = Math.random() * (6 - 3) + 3; // Next glitch in 0.5 to 2 seconds

                        el.style.filter = `url(#${randomFilterId})`;

                        setTimeout(() => {
                            el.style.filter = 'none';
                            setTimeout(applyGlitch, delayBeforeNextGlitch * 1000);
                        }, glitchDuration * 1000);
                    }

                    // Initial glitch after a random delay
                    setTimeout(applyGlitch, Math.random() * 3000); // Initial delay up to 3 seconds
                });

                // Theme switching logic
                const themeToggleBtn = document.getElementById('theme-toggle');
                const body = document.body;

                function toggleTheme() {
                    if (body.classList.contains('theme-red')) {
                        body.classList.remove('theme-red');
                        body.classList.add('theme-purple');
                        localStorage.setItem('theme', 'theme-purple');
                    } else if (body.classList.contains('theme-purple')) {
                        body.classList.remove('theme-purple');
                        body.classList.add('theme-blue');
                        localStorage.setItem('theme', 'theme-blue');
                    } else if (body.classList.contains('theme-blue')) {
                        body.classList.remove('theme-blue');
                        body.classList.add('theme-light');
                        localStorage.setItem('theme', 'theme-light');
                    } else {
                        body.classList.remove('theme-light');
                        body.classList.add('theme-red');
                        localStorage.setItem('theme', 'theme-red');
                    }
                }

                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', toggleTheme);
                }
            });
        </script> <script type="module">document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".persistent-highlight").forEach(t=>{const s=t.dataset.noteId,o=t.dataset.noteText;if(!t||!s||!o)return;let e=null;e=document.createElement("div"),e.className="persistent-note-block",e.dataset.noteId=s,e.innerHTML=`<p>${o}</p>`;let n=t.closest("p");if(n===null){let a=t;for(;a&&a.nextElementSibling;)if(a=a.nextElementSibling,a.tagName==="P"){n=a;break}}n&&n.parentNode&&n.parentNode.insertBefore(e,n.nextSibling),t.addEventListener("mouseenter",()=>{e.classList.add("glow-active")}),t.addEventListener("mouseleave",()=>{e.classList.remove("glow-active")}),e.addEventListener("mouseenter",()=>{t.classList.add("highlight-active"),e.classList.add("glow-active")}),e.addEventListener("mouseleave",()=>{t.classList.remove("highlight-active"),e.classList.remove("glow-active")})})});</script> </body> </html>