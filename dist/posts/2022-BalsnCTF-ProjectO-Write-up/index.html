<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/png" href="/favicon.png"><meta name="generator" content="Astro v5.11.1"><title>NiNi's Den. CyberSec Blog</title><link rel="stylesheet" href="/src/styles/cyber-space-theme.css"><link rel="stylesheet" href="/src/styles/light-theme.css"><style>.post-image-wrapper[data-astro-cid-no5unav3]{margin:1.5em auto;max-width:100%;position:relative;display:inline-block}.post-image-wrapper[data-astro-cid-no5unav3]:before{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background-color:rgba(var(--color-accent-r),var(--color-accent-g),var(--color-accent-b),1);mix-blend-mode:color;pointer-events:none;transition:opacity .3s ease-in-out;opacity:1}.post-image-wrapper[data-astro-cid-no5unav3]:hover:before{opacity:0}.post-image[data-astro-cid-no5unav3]{display:block;max-width:100%;height:auto;border:1px solid var(--color-border);box-shadow:0 0 10px #0009;transition:all .3s ease-in-out}.post-image[data-astro-cid-no5unav3]:hover{filter:brightness(1) contrast(1);box-shadow:0 0 15px rgba(var(--color-accent-r),var(--color-accent-g),var(--color-accent-b),.7)}
</style></head> <body style="margin: 0; padding-top: 60px;"> <script>
            // Apply theme from localStorage immediately to prevent FOUC
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.body.classList.add(savedTheme);
            } else {
                document.body.classList.add('theme-light'); // Default theme
                localStorage.setItem('theme', 'theme-light');
            }
        </script> <button id="theme-toggle" class="theme-toggle-btn">
切換主題
</button> <nav class="main-nav"> <ul class="main-nav-list"> <li class="main-nav-item"><a href="/" class="main-nav-link">Home</a></li> <li class="main-nav-item"><a href="/about" class="main-nav-link">About</a></li> </ul> </nav>  <div class="article-page-wrapper"> <aside class="author-hud"> <div class="author-hud-content glitchable"> <img src="//avatars2.githubusercontent.com/u/15998206" alt="NiNi's avatar" class="author-avatar"> <div class="author-info"> <h4><a href="https://balsn.tw/">NiNi</a></h4> <p class="title">Security Researcher</p> </div> </div> </aside> <div class="container"> <article class="post-content"> <h1>2022::BalsnCTF::ProjectO Write-up</h1> <p class="post-meta">Published: 2022-09-12 | Category: CTF</p> <p>Hi, I’m the author of ProjectO. To solve the challenge, player must reversing the game server to understand the protocol and mechanism.
A semi-auto game client is sufficient to gain the flag.</p>
<h2 id="msvc-stl">MSVC STL</h2>
<p>Though the binary is stripped, it’s not difficult to recognize it’s using some STLs in C++. But one should quickly realize that the layout of structures are differ from their equivalent in libc++. The concept is similar, it’s should not be a problem to figure out the correct layout. Here is the <a href="https://github.com/microsoft/STL">source code of MSVC STL</a>. In case you have no idea about the libc++ STL, this is <a href="https://flagbot.ch/lesson6.pdf">the tutorial made by flagbog</a>.</p>
<h2 id="protocol-buffers">Protocol Buffers</h2>
<p>Both of the code of server logic and the protobuf library were chosen as Release version at compile stage, but the information of protocol buffers wasn’t stripped. It helps to understand the functionality of the binary. The problem is how to send a valid request.</p>
<p>First step is to find out the vtable of protobuf, e.g the <code>balsn::Request::vftable</code> is the vtable of <code>Request</code> message in package <code>balsn</code>. One of the functions in vtable contains the implementation of serialization. By following the function at <code>0x000140015A30</code>, we can target the function responsible for serialization stored at <code>vtable+0x48</code>, which is <code>sub_1400020D0</code>:</p>
<pre><code class="language-c" metastring="0x00140015A30">...
 else
  {
    v10 = 16;
    v8 = &amp;a2[v5 - 16];
    v7 = v8;
    v9 = (__int64)v11 + 8;
  }
  if ( !(*(__int64 (__fastcall **)(__int64, char *, char **))(*(_QWORD *)a1 + 0x48i64))(a1, a2, &amp;v7) || (_DWORD)v14 )
    return 0;
  else
    return sub_140015440((__int64)&amp;v7, a1, 1);
}
</code></pre>
<p>A number in protobuf is represent by <a href="https://en.wikipedia.org/wiki/Variable-length_quantity">Variant Length Integer</a>, the pattern can be observed in function <code>sub_140012B80</code>, which also being called in <code>sub_1400020D0</code>.</p>
<pre><code class="language-c" metastring="sub_1400020D0">...
if ( v8 &gt;&gt; 3 == 1 )
    {
      if ( (_BYTE)v8 != 8 )
        goto LABEL_35;
      v12 = *a2;
      v3 |= 2u;
      if ( (v12 &amp; 0x80u) != 0 )
      {
        v12 = (a2[1] &lt;&lt; 7) + v12 - 128;
        if ( (a2[1] &amp; 0x80u) != 0 )
        {
          sub_140012B80(&amp;v22, a2, v12);
          v12 = v23;
          a2 = v22;
        }
        else
        {
          a2 += 2;
        }
      }
...
</code></pre>
<p>But it’s time consuming to review each of such functions of every types of message. Actually, after parsing a member of a message, the protobuf set a bit in the structure to indicate the present/absent of a member:</p>
<pre><code class="language-c" metastring="sub_1400020D0">...
 if ( v8 &gt;&gt; 3 == 1 )
    {
      if ( (_BYTE)v8 != 8 )
        goto LABEL_35;
      v12 = *a2;
      v3 |= 2u;     //set the bit corresponding bit
      if ( (v12 &amp; 0x80u) != 0 )
      {
...
   else if ( v8 &gt;&gt; 3 == 2 )
    {
      if ( (_BYTE)v8 != 16 )
        goto LABEL_35;
      v11 = *a2;
      v3 |= 4u;     //set the bit corresponding bit
      if ( (v11 &amp; 0x80u) != 0 )
...
  *(_DWORD *)(a1 + 16) |= v3;   // assign the value
  return a2;
}
</code></pre>
<p>So, by following the usage of each message, we can construct the message now. Though the name of members are unimportant, you can find them in binary. The source code of message:</p>
<pre><code class="language-proto" metastring="message.proto">syntax = &quot;proto2&quot;;

package balsn;

message Request {
  required int32   module = 1;
  required uint32  command = 2;
  optional bytes data = 3;
}

message Auth{
	optional string username=1;
	optional string password=2;
}

message Control{
	required int32 direction = 1;
}

message Info{
	required int32 which = 1;
	required int32 what = 2;
}

message Point{
	required int32 x = 1;
	required int32 y = 2;
}

message Response {
	required int32 status = 1;
	optional int32 iData = 2;
	repeated Point pData = 3;
	optional bytes bData = 4;
}
</code></pre>
<p>Besides the protobuf itself, the binary required client to send the length of the incoming protobuf, it looks like:</p>
<pre><code>| (4 bytes) length of message | message |
</code></pre>
<h2 id="the-game">The Game</h2>
<p>The game is:</p>
<ul>
<li>10 levels of random generated MAZE with 10 enemies and a portal to next level</li>
<li>Have to kill 70 enemies to claim the flag after level 10</li>
<li>Enemies won’t move and only slash it’s adjacent blocks every 3 turns</li>
<li>Player only has 1 HP</li>
<li>Connection timeout after 12 minutes</li>
</ul>
<p>That’s it, just write a semi-auto client to reach the goal.
It’s possible! Check out the <a href="https://discord.com/channels/618345806013005824/1016229449412378645">#writeups channel</a> on Discord.
And this <a href="https://github.com/terrynini/MyCTFChallenges/tree/master/BalsnCTF_2022_challenge/ProjectO/solution">github repo</a> contains the source code of the challenge.</p> </article> </div> <aside class="article-outline-hud" data-augmented-ui="tl-clip tr-clip br-clip bl-clip border"> <div class="article-outline-hud-content glitchable"> <h2>文章大綱</h2> <nav> <ul> <li> <a href="#msvc-stl">MSVC STL</a> </li><li> <a href="#protocol-buffers">Protocol Buffers</a> </li><li> <a href="#the-game">The Game</a> </li> </ul> </nav> </div> </aside> </div> <div id="persistent-notes-overlay"></div> <script>
        document.addEventListener('DOMContentLoaded', () => {
            const highlightElements = document.querySelectorAll('.persistent-highlight');
            const notesOverlay = document.getElementById('persistent-notes-overlay');
            const containerElement = document.querySelector('.container');

            const positionNotes = () => {
                notesOverlay.innerHTML = ''; 
                if (!containerElement) return; 

                
                if (window.innerWidth > 1024) {
                    const containerRect = containerElement.getBoundingClientRect();
                    const noteWidth = 220; 
                    const margin = 60; 

                    highlightElements.forEach(highlightEl => {
                        const noteId = highlightEl.dataset.noteId;
                        const noteText = highlightEl.dataset.noteText; 

                        const rect = highlightEl.getBoundingClientRect();

                        const noteDiv = document.createElement('div');
                        noteDiv.className = 'persistent-note-item';
                        noteDiv.setAttribute('data-note-id', noteId);
                        noteDiv.innerHTML = `<p>${noteText}</p>`;

                        
                        noteDiv.style.position = 'absolute'; 
                        noteDiv.style.top = `${rect.top}px`; 
                        noteDiv.style.left = `${containerRect.left - noteWidth - margin}px`; 
                        noteDiv.style.width = `${noteWidth}px`;

                        notesOverlay.appendChild(noteDiv);

                        
                        highlightEl.addEventListener('mouseenter', () => {
                            noteDiv.classList.add('sci-fi-active');
                        });
                        highlightEl.addEventListener('mouseleave', () => {
                            noteDiv.classList.remove('sci-fi-active');
                        });

                        
                        noteDiv.addEventListener('mouseenter', () => {
                            highlightEl.classList.add('highlight-active');
                        });
                        noteDiv.addEventListener('mouseleave', () => {
                            highlightEl.classList.remove('highlight-active');
                        });
                    });
                }
            };

            
            positionNotes();

            
            window.addEventListener('scroll', positionNotes);
            window.addEventListener('resize', positionNotes);
        });
    </script> <style>
        
        .post-content img {
            max-width: 100%;
            height: auto;
            display: block; 
            margin: 0 auto; 
        }

        

        #persistent-notes-overlay {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none; 
            z-index: 5; 
        }

        @media (max-width: 1200px) {
            #persistent-notes-overlay {
                display: none; 
            }
        }

        .persistent-note-item {
            pointer-events: auto; 
            
        }
    </style>  <svg xmlns="http://www.w3.org/2000/svg" version="1.1" style="position: absolute; top: -9999px; left: -9999px;"> <defs> <filter id="dist-01"> <feTurbulence id="turbulence" baseFrequency="0.02" numOctaves="8" result="noise" seed="0"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-02"> <feTurbulence id="turbulence" baseFrequency="0.2" numOctaves="8" result="noise" seed="1"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-03"> <feTurbulence id="turbulence" baseFrequency="0.01" numOctaves="6" result="noise" seed="2"></feTurbulence> <feConvolveMatrix in="noise" order="3" result="snoise" kernelMatrix="
						0  -1   0
						-1   5  -1
						0  -1   0    
					"></feConvolveMatrix> <feDisplacementMap id="displacement" in="SourceGraphic" in2="snoise" scale="6"></feDisplacementMap> </filter> <filter id="dist-04"> <feTurbulence id="turbulence" baseFrequency="0.01" numOctaves="6" result="noise" seed="2" type="fractalNoise"></feTurbulence> <feDisplacementMap id="displacement" in="SourceGraphic" in2="noise" scale="6"></feDisplacementMap> </filter> <!-- Additional Glitch Filters for more variety --> <filter id="dist-05"> <feTurbulence baseFrequency="0.05" numOctaves="4" result="noise" seed="3"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="10"></feDisplacementMap> </filter> <filter id="dist-06"> <feTurbulence baseFrequency="0.1" numOctaves="2" result="noise" seed="4"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="8"></feDisplacementMap> </filter> <filter id="dist-07"> <feTurbulence baseFrequency="0.03" numOctaves="6" result="noise" seed="5" type="fractalNoise"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="12"></feDisplacementMap> </filter> <filter id="dist-08"> <feTurbulence baseFrequency="0.08" numOctaves="3" result="noise" seed="6"></feTurbulence> <feDisplacementMap in="SourceGraphic" in2="noise" scale="5"></feDisplacementMap> </filter> </defs> </svg> <script>
            document.addEventListener('DOMContentLoaded', () => {
                const glitchableElements = document.querySelectorAll('.glitchable');
                const filters = ['dist-01', 'dist-02', 'dist-03', 'dist-04', 'dist-05', 'dist-06', 'dist-07', 'dist-08'];

                glitchableElements.forEach(el => {
                    function applyGlitch() {
                        const randomFilterId = filters[Math.floor(Math.random() * filters.length)];
                        const glitchDuration = 0.08//Math.random() * (0.1 - 0.05) + 0.05; // Glitch lasts between 0.05 and 0.1 seconds
                        const delayBeforeNextGlitch = Math.random() * (6 - 3) + 3; // Next glitch in 0.5 to 2 seconds

                        el.style.filter = `url(#${randomFilterId})`;

                        setTimeout(() => {
                            el.style.filter = 'none';
                            setTimeout(applyGlitch, delayBeforeNextGlitch * 1000);
                        }, glitchDuration * 1000);
                    }

                    // Initial glitch after a random delay
                    setTimeout(applyGlitch, Math.random() * 3000); // Initial delay up to 3 seconds
                });

                // Theme switching logic
                const themeToggleBtn = document.getElementById('theme-toggle');
                const body = document.body;

                function toggleTheme() {
                    if (body.classList.contains('theme-red')) {
                        body.classList.remove('theme-red');
                        body.classList.add('theme-purple');
                        localStorage.setItem('theme', 'theme-purple');
                    } else if (body.classList.contains('theme-purple')) {
                        body.classList.remove('theme-purple');
                        body.classList.add('theme-blue');
                        localStorage.setItem('theme', 'theme-blue');
                    } else if (body.classList.contains('theme-blue')) {
                        body.classList.remove('theme-blue');
                        body.classList.add('theme-light');
                        localStorage.setItem('theme', 'theme-light');
                    } else {
                        body.classList.remove('theme-light');
                        body.classList.add('theme-red');
                        localStorage.setItem('theme', 'theme-red');
                    }
                }

                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', toggleTheme);
                }
            });
        </script> <script type="module">document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".persistent-highlight").forEach(t=>{const s=t.dataset.noteId,o=t.dataset.noteText;if(!t||!s||!o)return;let e=null;e=document.createElement("div"),e.className="persistent-note-block",e.dataset.noteId=s,e.innerHTML=`<p>${o}</p>`;let n=t.closest("p");if(n===null){let a=t;for(;a&&a.nextElementSibling;)if(a=a.nextElementSibling,a.tagName==="P"){n=a;break}}n&&n.parentNode&&n.parentNode.insertBefore(e,n.nextSibling),t.addEventListener("mouseenter",()=>{e.classList.add("glow-active")}),t.addEventListener("mouseleave",()=>{e.classList.remove("glow-active")}),e.addEventListener("mouseenter",()=>{t.classList.add("highlight-active"),e.classList.add("glow-active")}),e.addEventListener("mouseleave",()=>{t.classList.remove("highlight-active"),e.classList.remove("glow-active")})})});</script> </body> </html>